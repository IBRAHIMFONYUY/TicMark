<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AttendanceHub - Professional Attendance Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsqr/1.4.0/jsQR.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>

    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap");

      * {
        font-family: "Inter", sans-serif;
      }

      .gradient-bg {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      .hidden-class {
        display: none;
      }

      .glass-effect {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .slide-in {
        animation: slideIn 0.5s ease-out;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .pulse-animation {
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .scanner-overlay {
        position: relative;
        overflow: hidden;
      }

      .scanner-line {
        position: absolute;
        width: 100%;
        height: 2px;
        background: linear-gradient(90deg, transparent, #10b981, transparent);
        animation: scan 2s linear infinite;
      }

      @keyframes scan {
        0% {
          top: 0;
        }
        100% {
          top: 100%;
        }
      }

      .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
      }

      .status-online {
        background-color: #10b981;
      }
      .status-offline {
        background-color: #ef4444;
      }
      .status-away {
        background-color: #f59e0b;
      }

      .checkout-btn {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        transition: all 0.3s ease;
      }

      .checkout-btn:hover {
        background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
      }

      .loading-spinner {
        border: 2px solid #f3f4f6;
        border-top: 2px solid #3b82f6;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .notification {
        transform: translateX(100%);
        transition: transform 0.3s ease-in-out;
      }

      .notification.show {
        transform: translateX(0);
      }

      .error-message {
        color: #ef4444;
        font-size: 0.875rem;
        margin-top: 0.25rem;
      }

      .offline-indicator {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: #ef4444;
        color: white;
        text-align: center;
        padding: 0.5rem;
        z-index: 1000;
        transform: translateY(-100%);
        transition: transform 0.3s ease;
      }

      .offline-indicator.show {
        transform: translateY(0);
      }

      @media (max-width: 640px) {
        .grid {
          grid-template-columns: repeat(1, minmax(0, 1fr));

        }
        .qrgen{
          display: none;
        }
        .sta-msg{
          display:none
        }
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <!-- Offline Indicator -->
    <div id="offlineIndicator" class="offline-indicator">
      <i class="fas fa-wifi-slash mr-2"></i>
      You're offline. Some features may not work properly.
    </div>

    <!-- Notification Container -->
    <div
      id="notificationContainer"
      class="fixed top-4 right-4 z-50 space-y-2"
    ></div>

    <!-- Loading Overlay -->
    <div
      id="loadingOverlay"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
    >
      <div class="bg-white rounded-lg p-6 flex items-center space-x-3">
        <div class="loading-spinner"></div>
        <span class="text-gray-700">Processing...</span>
      </div>
    </div>

    <!-- Main Container -->
    <div id="app" class="min-h-screen">
      <!-- Landing Page -->
      <div
        id="landingPage"
        class="gradient-bg min-h-screen flex items-center justify-center p-4"
      >
        <div class="max-w-4xl mx-auto text-center text-white slide-in">
          <div class="mb-8">
            <i class="fas fa-clipboard-check text-6xl mb-4 opacity-90"></i>
            <h1 class="text-5xl font-bold mb-4">AttendanceHub</h1>
            <p class="text-xl opacity-90 mb-8">
              Professional Attendance Management Platform
            </p>
          </div>

          <div class="grid md:grid-cols-2 gap-6 mb-8">
            <div class="glass-effect rounded-xl p-6">
              <i class="fas fa-user-graduate text-3xl mb-4"></i>
              <h3 class="text-xl font-semibold mb-2">Intern Portal</h3>
              <p class="opacity-80 mb-4">
                Mark attendance with QR codes or manual check-in/out
              </p>
              <button
                onclick="showLogin('intern')"
                class="bg-white text-blue-600 px-6 py-2 rounded-lg font-medium hover:bg-gray-100 transition-colors"
              >
                Intern Login
              </button>
            </div>

            <div class="glass-effect rounded-xl p-6">
              <i class="fas fa-user-tie text-3xl mb-4"></i>
              <h3 class="text-xl font-semibold mb-2">Admin Portal</h3>
              <p class="opacity-80 mb-4">
                Manage interns and monitor real-time attendance
              </p>
              <button
                onclick="showLogin('admin')"
                class="bg-white text-blue-600 px-6 py-2 rounded-lg font-medium hover:bg-gray-100 transition-colors"
              >
                Admin Login
              </button>
            </div>
          </div>

          <div class="text-sm opacity-75">
            <p>Secure • Real-time • Location-verified • Professional</p>
            <p class="mt-2">Company Location: 3.0°N, 11.0°E</p>
          </div>
        </div>
      </div>

      <!-- Login Page -->
      <div
        id="loginPage"
        class="hidden min-h-screen gradient-bg flex items-center justify-center p-4"
      >
        <div
          class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md slide-in"
        >
          <div class="text-center mb-8">
            <i class="fas fa-clipboard-check text-4xl text-blue-600 mb-4"></i>
            <h2 class="text-2xl font-bold text-gray-800" id="loginTitle">
              Login
            </h2>
            <p class="text-gray-600" id="loginSubtitle">
              Access your dashboard
            </p>
          </div>

          <form id="loginForm" class="space-y-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Email</label
              >
              <input
                type="email"
                id="loginEmail"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
              />
              <div id="loginEmailError" class="error-message hidden"></div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Password</label
              >
              <div class="relative">
                <input
                  type="password"
                  id="loginPassword"
                  required
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all pr-12"
                />
                <button
                  type="button"
                  onclick="togglePassword('loginPassword')"
                  class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"
                >
                  <i class="fas fa-eye"></i>
                </button>
              </div>
              <div id="loginPasswordError" class="error-message hidden"></div>
            </div>

            <div class="flex items-center justify-between">
              <label class="flex items-center">
                <input
                  type="checkbox"
                  class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                />
                <span class="ml-2 text-sm text-gray-600">Remember me</span>
              </label>
              <button
                type="button"
                onclick="showForgotPassword()"
                class="text-sm text-blue-600 hover:text-blue-800"
              >
                Forgot password?
              </button>
            </div>

            <button
              type="submit"
              class="w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            >
              Sign In
            </button>
          </form>

          <div class="mt-6">
            <div class="relative">
              <div class="absolute inset-0 flex items-center">
                <div class="w-full border-t border-gray-300"></div>
              </div>
              <div class="relative flex justify-center text-sm">
                <span class="px-2 bg-white text-gray-500"
                  >Or continue with</span
                >
              </div>
            </div>

            <button
              onclick="signInWithGoogle(window.userRole)"
              class="mt-4 w-full flex items-center justify-center px-4 py-3 border border-gray-300 rounded-lg shadow-sm bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors"
            >
              <svg class="w-5 h-5 mr-3" viewBox="0 0 24 24">
                <path
                  fill="#4285F4"
                  d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
                />
                <path
                  fill="#34A853"
                  d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
                />
                <path
                  fill="#FBBC05"
                  d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
                />
                <path
                  fill="#EA4335"
                  d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
                />
              </svg>
              Continue with Google
            </button>
          </div>

          <div class="mt-6 text-center">
            <p class="text-sm text-gray-600">
              Don't have an account?
              <button
                onclick="showSignup()"
                class="text-blue-600 hover:text-blue-800 font-medium"
              >
                Sign up
              </button>
            </p>
          </div>

          <button
            onclick="showLanding()"
            class="mt-4 text-sm text-gray-500 hover:text-gray-700 flex items-center mx-auto"
          >
            <i class="fas fa-arrow-left mr-2"></i>Back to home
          </button>
        </div>
      </div>

      <!-- Signup Page -->
      <div
        id="signupPage"
        class="hidden min-h-screen gradient-bg flex items-center justify-center p-4"
      >
        <div
          class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md slide-in"
        >
          <div class="text-center mb-8">
            <i class="fas fa-user-plus text-4xl text-blue-600 mb-4"></i>
            <h2 class="text-2xl font-bold text-gray-800">Create Account</h2>
            <p class="text-gray-600">Join AttendanceHub</p>
          </div>

          <form id="signupForm" class="space-y-6">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >First Name</label
                >
                <input
                  type="text"
                  id="firstName"
                  required
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                />
                <div id="firstNameError" class="error-message hidden"></div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Last Name</label
                >
                <input
                  type="text"
                  id="lastName"
                  required
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                />
                <div id="lastNameError" class="error-message hidden"></div>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Email</label
              >
              <input
                type="email"
                id="signupEmail"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
              />
              <div id="signupEmailError" class="error-message hidden"></div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Employee ID</label
              >
              <input
                type="text"
                id="employeeId"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
              />
              <div id="employeeIdError" class="error-message hidden"></div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Department</label
              >
              <select
                id="department"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
              >
                <option value="">Select Department</option>
                <option value="Web Dev">Web Dev</option>
                <option value="Marketing">Marketing</option>
                <option value="Human Resources">Human Resources</option>
                <option value="Designing">Designing</option>
                <option value="Cyber Security">Cyber Security</option>
              </select>
              <div id="departmentError" class="error-message hidden"></div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Password</label
              >
              <div class="relative">
                <input
                  type="password"
                  id="signupPassword"
                  required
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all pr-12"
                />
                <button
                  type="button"
                  onclick="togglePassword('signupPassword')"
                  class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"
                >
                  <i class="fas fa-eye"></i>
                </button>
              </div>
              <div class="mt-2 text-xs text-gray-500">
                Password must be at least 8 characters with uppercase,
                lowercase, and number
              </div>
              <div id="signupPasswordError" class="error-message hidden"></div>
            </div>

            <button
              type="submit"
              class="w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            >
              Create Account
            </button>
          </form>

          <div class="mt-6">
            <div class="relative">
              <div class="absolute inset-0 flex items-center">
                <div class="w-full border-t border-gray-300"></div>
              </div>
              <div class="relative flex justify-center text-sm">
                <span class="px-2 bg-white text-gray-500">Or sign up with</span>
              </div>
            </div>

            <button
              onclick="signInWithGoogle('intern')"
              class="mt-4 w-full flex items-center justify-center px-4 py-3 border border-gray-300 rounded-lg shadow-sm bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors"
            >
              <svg class="w-5 h-5 mr-3" viewBox="0 0 24 24">
                <path
                  fill="#4285F4"
                  d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
                />
                <path
                  fill="#34A853"
                  d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
                />
                <path
                  fill="#FBBC05"
                  d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
                />
                <path
                  fill="#EA4335"
                  d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
                />
              </svg>
              Sign up with Google
            </button>
          </div>

          <div class="mt-6 text-center">
            <p class="text-sm text-gray-600">
              Already have an account?
              <button
                onclick="showLogin('intern')"
                class="text-blue-600 hover:text-blue-800 font-medium"
              >
                Sign in
              </button>
            </p>
          </div>

          <button
            onclick="showLanding()"
            class="mt-4 text-sm text-gray-500 hover:text-gray-700 flex items-center mx-auto"
          >
            <i class="fas fa-arrow-left mr-2"></i>Back to home
          </button>
        </div>
      </div>

      <!-- Forgot Password Page -->
      <div
        id="forgotPasswordPage"
        class="hidden min-h-screen gradient-bg flex items-center justify-center p-4"
      >
        <div
          class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md slide-in"
        >
          <div class="text-center mb-8">
            <i class="fas fa-key text-4xl text-blue-600 mb-4"></i>
            <h2 class="text-2xl font-bold text-gray-800">Reset Password</h2>
            <p class="text-gray-600">
              Enter your email to receive reset instructions
            </p>
          </div>

          <form id="forgotPasswordForm" class="space-y-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Email Address</label
              >
              <input
                type="email"
                id="resetEmail"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
              />
              <div id="resetEmailError" class="error-message hidden"></div>
            </div>

            <button
              type="submit"
              class="w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            >
              Send Reset Link
            </button>
          </form>

          <div class="mt-6 text-center">
            <button
              onclick="showLogin('intern')"
              class="text-sm text-blue-600 hover:text-blue-800 font-medium"
            >
              Back to login
            </button>
          </div>
        </div>
      </div>

      <!-- Intern Dashboard -->
      <div id="internDashboard" class="hidden min-h-screen bg-gray-50">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
          <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
              <div class="flex items-center">
                <i
                  class="fas fa-clipboard-check text-2xl text-blue-600 mr-3"
                ></i>
                <h1 class="text-xl font-semibold text-gray-900">
                  AttendanceHub
                </h1>
                <div class="ml-4 flex items-center">
                  <span class="status-indicator status-online"></span>
                  <span class="sta-msg text-sm text-gray-600"
                    >Real-time sync active</span
                  >
                </div>
              </div>

              <div class="flex items-center space-x-4">
                <div class="relative">
                  <button
                    onclick="toggleUserMenu()"
                    class="flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-100"
                  >
                    <div
                      id="userAvatar"
                      class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white text-sm font-medium"
                    >
                      U
                    </div>
                    <span
                      id="userName"
                      class="text-sm font-medium text-gray-700"
                      >User</span
                    >
                    <i class="fas fa-chevron-down text-xs text-gray-500"></i>
                  </button>

                  <div
                    id="userMenu"
                    class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border z-10"
                  >
                    <div class="py-1">
                      <button
                        onclick="showProfile()"
                        class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                      >
                        <i class="fas fa-user mr-2"></i>Profile
                      </button>
                      <button
                        onclick="showSettings()"
                        class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                      >
                        <i class="fas fa-cog mr-2"></i>Settings
                      </button>
                      <hr class="my-1" />
                      <button
                        onclick="logout()"
                        class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100"
                      >
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
          <!-- Current Status Card -->
          <div
            id="currentStatusCard"
            class="bg-white rounded-xl shadow-sm p-6 border mb-8"
          >
            <div class="flex items-center justify-between">
              <div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">
                  Current Status
                </h3>
                <div id="currentStatus" class="flex items-center">
                  <span class="status-indicator status-offline"></span>
                  <span class="text-gray-600">Not checked in</span>
                </div>
              </div>
              <div class="text-right">
                <div id="workingHours" class="text-2xl font-bold text-gray-900">
                  0:00
                </div>
                <div class="text-sm text-gray-500">Hours today</div>
              </div>
            </div>
          </div>

          <!-- Quick Stats -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-sm p-6 border">
              <div class="flex items-center">
                <div class="p-3 bg-green-100 rounded-lg">
                  <i class="fas fa-calendar-check text-green-600 text-xl"></i>
                </div>
                <div class="ml-4">
                  <p class="text-sm font-medium text-gray-600">This Month</p>
                  <p
                    id="monthlyAttendance"
                    class="text-2xl font-bold text-gray-900"
                  >
                    0/0
                  </p>
                </div>
              </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-6 border">
              <div class="flex items-center">
                <div class="p-3 bg-blue-100 rounded-lg">
                  <i class="fas fa-clock text-blue-600 text-xl"></i>
                </div>
                <div class="ml-4">
                  <p class="text-sm font-medium text-gray-600">Avg. Hours</p>
                  <p id="avgHours" class="text-2xl font-bold text-gray-900">
                    0h
                  </p>
                </div>
              </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-6 border">
              <div class="flex items-center">
                <div class="p-3 bg-yellow-100 rounded-lg">
                  <i
                    class="fas fa-exclamation-triangle text-yellow-600 text-xl"
                  ></i>
                </div>
                <div class="ml-4">
                  <p class="text-sm font-medium text-gray-600">Late Days</p>
                  <p id="lateDays" class="text-2xl font-bold text-gray-900">
                    0
                  </p>
                </div>
              </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-6 border">
              <div class="flex items-center">
                <div class="p-3 bg-purple-100 rounded-lg">
                  <i class="fas fa-trophy text-purple-600 text-xl"></i>
                </div>
                <div class="ml-4">
                  <p class="text-sm font-medium text-gray-600">Streak</p>
                  <p id="streak" class="text-2xl font-bold text-gray-900">
                    0 days
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Check-in/out Section -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- QR Code Check-in/out -->
            <div class="bg-white rounded-xl shadow-sm p-6 border">
              <h3
                class="text-lg font-semibold text-gray-900 mb-4 flex items-center"
              >
                <i class="fas fa-qrcode text-blue-600 mr-2"></i>
                QR Code Scanner
              </h3>
              <div class="text-center">
                <div
                  id="qrScanner"
                  class="scanner-overlay bg-gray-100 rounded-lg p-8 mb-4 relative"
                >
                  <div class="scanner-line"></div>
                  <i class="fas fa-camera text-4xl text-gray-400 mb-4"></i>
                  <p class="text-gray-600 mb-4">
                    Scan QR code to check-in or check-out
                  </p>
                </div>
                <video
                  id="qrVideo"
                  class="hidden w-full rounded-lg max-w-full"
                ></video>
                <canvas id="qrCanvas" class="hidden"></canvas>
                <div
                  class="flex flex-col mt-5 sm:flex-row gap-2 justify-center"
                >
                  <button
                    onclick="startQRScan()"
                    class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                  >
                    <i class="fas fa-play mr-2"></i>Start Camera
                  </button>
                  <button
                    onclick="stopQRScan()"
                    class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition-colors"
                  >
                    <i class="fas fa-stop mr-2"></i>Stop Camera
                  </button>
                </div>
              </div>
            </div>

            <!-- Manual Check-in/out -->
            <div class="bg-white rounded-xl shadow-sm p-6 border">
              <h3
                class="text-lg font-semibold text-gray-900 mb-4 flex items-center"
              >
                <i class="fas fa-hand-pointer text-green-600 mr-2"></i>
                Manual Check-in/out
              </h3>

              <div class="text-center">
                <div class="bg-gray-50 rounded-lg p-8 mb-4">
                  <div id="locationStatus" class="mb-4">
                    <i
                      class="fas fa-map-marker-alt text-2xl text-green-500 mb-2"
                    ></i>
                    <p
                      class="text-green-600 font-medium"
                      id="locationMessage"
                    ></p>
                    <p class="text-xs text-gray-500" id="locationDistance"></p>
                  </div>

                  <div
                    id="checkInTime"
                    class="text-3xl font-bold text-gray-900 mb-2"
                  >
                    --:-- --
                  </div>
                  <div class="text-sm text-gray-500 mb-4" id="currentDate">
                    Loading...
                  </div>

                  <div id="attendanceButtons" class="space-y-3">
                    <button
                      id="checkInBtn"
                      onclick="manualCheckIn()"
                      class="w-full bg-green-600 text-white px-8 py-3 rounded-lg font-medium hover:bg-green-700 transition-colors pulse-animation"
                    >
                      <i class="fas fa-sign-in-alt mr-2"></i>Check In Now
                    </button>

                    <button
                      id="checkOutBtn"
                      onclick="manualCheckOut()"
                      class="w-full checkout-btn text-white px-8 py-3 rounded-lg font-medium hidden"
                    >
                      <i class="fas fa-sign-out-alt mr-2"></i>Check Out Now
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Recent Activity & Calendar -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Recent Activity -->
            <div class="bg-white rounded-xl shadow-sm p-6 border">
              <h3
                class="text-lg font-semibold text-gray-900 mb-4 flex items-center"
              >
                <i class="fas fa-history text-purple-600 mr-2"></i>
                Recent Activity
              </h3>

              <div id="recentActivity" class="space-y-4">
                <div class="text-center text-gray-500 py-8">
                  <i class="fas fa-clock text-2xl mb-2"></i>
                  <p>No recent activity</p>
                </div>
              </div>

              <button
                class="w-full mt-4 text-blue-600 hover:text-blue-800 text-sm font-medium"
              >
                View All Activity
              </button>
            </div>

            <!-- Mini Calendar -->
            <div class="bg-white rounded-xl shadow-sm p-6 border">
              <h3
                class="text-lg font-semibold text-gray-900 mb-4 flex items-center"
              >
                <i class="fas fa-calendar text-indigo-600 mr-2"></i>
                Attendance Calendar
              </h3>

              <div id="attendanceCalendar">
                <div class="text-center mb-4">
                  <h4
                    class="text-lg font-semibold text-gray-900"
                    id="calendarMonth"
                  >
                    Loading...
                  </h4>
                </div>
                <div
                  class="grid grid-cols-7 gap-1 text-center text-xs font-medium text-gray-500 mb-2"
                >
                  <div>Sun</div>
                  <div>Mon</div>
                  <div>Tue</div>
                  <div>Wed</div>
                  <div>Thu</div>
                  <div>Fri</div>
                  <div>Sat</div>
                </div>
                <div class="grid grid-cols-7 gap-1" id="calendarDays">
                  <!-- Calendar days will be generated here -->
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>

      <!-- Profile Modal -->
      <div
        id="profileModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
      >
        <div
          class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md slide-in"
        >
          <div class="text-center mb-6">
            <div
              id="profileAvatar"
              class="w-20 h-20 bg-blue-600 rounded-full flex items-center justify-center text-white text-2xl font-bold mx-auto mb-4"
            >
              U
            </div>
            <h2 class="text-2xl font-bold text-gray-800">Profile</h2>
          </div>

          <form id="profileForm" class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >First Name</label
                >
                <input
                  type="text"
                  id="profileFirstName"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Last Name</label
                >
                <input
                  type="text"
                  id="profileLastName"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Email</label
              >
              <input
                type="email"
                id="profileEmail"
                disabled
                class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Employee ID</label
              >
              <input
                type="text"
                id="profileEmployeeId"
                disabled
                class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Department</label
              >
              <select
                id="profileDepartment"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              >
                <option value="">Select Department</option>
                <option value="engineering">Engineering</option>
                <option value="marketing">Marketing</option>
                <option value="hr">Human Resources</option>
                <option value="finance">Finance</option>
                <option value="operations">Operations</option>
              </select>
            </div>

            <div class="flex space-x-3 pt-4">
              <button
                type="submit"
                class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 transition-colors"
              >
                Update Profile
              </button>
              <button
                type="button"
                onclick="closeProfile()"
                class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-400 transition-colors"
              >
                Cancel
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Settings Modal -->
      <div
        id="settingsModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
      >
        <div
          class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md slide-in"
        >
          <div class="text-center mb-6">
            <i class="fas fa-cog text-4xl text-gray-600 mb-4"></i>
            <h2 class="text-2xl font-bold text-gray-800">Settings</h2>
          </div>

          <div class="space-y-4">
            <div
              class="flex items-center justify-between p-4 bg-gray-50 rounded-lg"
            >
              <div>
                <h3 class="font-medium text-gray-900">Email Notifications</h3>
                <p class="text-sm text-gray-500">
                  Receive attendance reminders
                </p>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input
                  type="checkbox"
                  id="emailNotifications"
                  class="sr-only peer"
                  checked
                />
                <div
                  class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"
                ></div>
              </label>
            </div>

            <div
              class="flex items-center justify-between p-4 bg-gray-50 rounded-lg"
            >
              <div>
                <h3 class="font-medium text-gray-900">Location Tracking</h3>
                <p class="text-sm text-gray-500">Verify attendance location</p>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input
                  type="checkbox"
                  id="locationTracking"
                  class="sr-only peer"
                  checked
                />
                <div
                  class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"
                ></div>
              </label>
            </div>

            <div
              class="flex items-center justify-between p-4 bg-gray-50 rounded-lg"
            >
              <div>
                <h3 class="font-medium text-gray-900">Dark Mode</h3>
                <p class="text-sm text-gray-500">Switch to dark theme</p>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="darkMode" class="sr-only peer" />
                <div
                  class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"
                ></div>
              </label>
            </div>

            <button
              onclick="changePassword()"
              class="w-full flex items-center justify-center p-4 bg-yellow-50 hover:bg-yellow-100 rounded-lg transition-colors"
            >
              <i class="fas fa-key text-yellow-600 mr-3"></i>
              <span class="text-yellow-700 font-medium">Change Password</span>
            </button>
          </div>

          <div class="flex space-x-3 pt-6">
            <button
              onclick="saveSettings()"
              class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 transition-colors"
            >
              Save Settings
            </button>
            <button
              onclick="closeSettings()"
              class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-400 transition-colors"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>

      <!-- Add Intern Modal -->
      <div
        id="addInternModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
      >
        <div
          class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md slide-in"
        >
          <div class="text-center mb-6">
            <i class="fas fa-user-plus text-4xl text-blue-600 mb-4"></i>
            <h2 class="text-2xl font-bold text-gray-800">Add New Intern</h2>
          </div>

          <form id="addInternForm" class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >First Name</label
                >
                <input
                  type="text"
                  id="newInternFirstName"
                  required
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Last Name</label
                >
                <input
                  type="text"
                  id="newInternLastName"
                  required
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Email</label
              >
              <input
                type="email"
                id="newInternEmail"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Employee ID</label
              >
              <input
                type="text"
                id="newInternEmployeeId"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Department</label
              >
              <select
                id="newInternDepartment"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              >
                <option value="">Select Department</option>
                <option value="engineering">Engineering</option>
                <option value="marketing">Marketing</option>
                <option value="hr">Human Resources</option>
                <option value="finance">Finance</option>
                <option value="operations">Operations</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Temporary Password</label
              >
              <input
                type="password"
                id="newInternPassword"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
              <p class="text-xs text-gray-500 mt-1">
                Intern will be asked to change this on first login
              </p>
            </div>

            <div class="flex space-x-3 pt-4">
              <button
                type="submit"
                class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 transition-colors"
              >
                Add Intern
              </button>
              <button
                type="button"
                onclick="closeAddIntern()"
                class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-400 transition-colors"
              >
                Cancel
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Profile Completion Modal -->
      <div
        id="profileCompletionModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
      >
        <div
          class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md slide-in"
        >
          <div class="text-center mb-6">
            <div
              id="googleUserAvatar"
              class="w-20 h-20 bg-blue-600 rounded-full flex items-center justify-center text-white text-2xl font-bold mx-auto mb-4"
            >
              <img
                id="googleUserPhoto"
                class="w-20 h-20 rounded-full hidden"
                alt="Profile"
              />
              <span id="googleUserInitials">U</span>
            </div>
            <h2 class="text-2xl font-bold text-gray-800">
              Complete Your Profile
            </h2>
            <p class="text-gray-600">
              Please provide additional information to complete your account
              setup
            </p>
          </div>

          <form id="profileCompletionForm" class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >First Name</label
                >
                <input
                  type="text"
                  id="googleFirstName"
                  required
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Last Name</label
                >
                <input
                  type="text"
                  id="googleLastName"
                  required
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Email</label
              >
              <input
                type="email"
                id="googleEmail"
                disabled
                class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Employee ID</label
              >
              <input
                type="text"
                id="googleEmployeeId"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
              <p class="text-xs text-gray-500 mt-1">
                Auto-generated ID can be modified
              </p>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Department</label
              >
              <select
                id="googleDepartment"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              >
                <option value="">Select Department</option>
                <option value="engineering">Engineering</option>
                <option value="marketing">Marketing</option>
                <option value="hr">Human Resources</option>
                <option value="finance">Finance</option>
                <option value="operations">Operations</option>
              </select>
            </div>

            <div class="bg-blue-50 p-4 rounded-lg">
              <div class="flex items-center">
                <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                <p class="text-sm text-blue-800">
                  Your Google account will be used for secure authentication
                </p>
              </div>
            </div>

            <button
              type="submit"
              class="w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 transition-colors"
            >
              Complete Profile
            </button>
          </form>
        </div>
      </div>

      <!-- Reports Modal -->
      <div
        id="reportsModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
      >
        <div
          class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-4xl slide-in max-h-[90vh] overflow-y-auto"
        >
          <div class="text-center mb-6">
            <i class="fas fa-chart-bar text-4xl text-orange-600 mb-4"></i>
            <h2 class="text-2xl font-bold text-gray-800">Attendance Reports</h2>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="bg-blue-50 p-4 rounded-lg">
              <h3 class="font-semibold text-blue-900 mb-2">This Week</h3>
              <p class="text-2xl font-bold text-blue-600" id="weeklyAttendance">
                0%
              </p>
              <p class="text-sm text-blue-700">Average attendance</p>
            </div>
            <div class="bg-green-50 p-4 rounded-lg">
              <h3 class="font-semibold text-green-900 mb-2">This Month</h3>
              <p
                class="text-2xl font-bold text-green-600"
                id="monthlyAttendanceRate"
              >
                0%
              </p>
              <p class="text-sm text-green-700">Attendance rate</p>
            </div>
            <div class="bg-purple-50 p-4 rounded-lg">
              <h3 class="font-semibold text-purple-900 mb-2">Total Hours</h3>
              <p class="text-2xl font-bold text-purple-600" id="totalHours">
                0h
              </p>
              <p class="text-sm text-purple-700">This month</p>
            </div>
          </div>

          <div class="bg-gray-50 p-4 rounded-lg mb-6">
            <h3 class="font-semibold text-gray-900 mb-4">Recent Activity</h3>
            <div
              id="reportsActivity"
              class="space-y-2 max-h-60 overflow-y-auto"
            >
              <!-- Activity items will be populated here -->
            </div>
          </div>

          <div class="flex justify-end space-x-3">
            <button
              onclick="viewEmailLog()"
              class="bg-blue-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-700 transition-colors"
            >
              <i class="fas fa-envelope mr-2"></i>Email Log
            </button>
            <button
              onclick="exportReports()"
              class="bg-green-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-green-700 transition-colors"
            >
              <i class="fas fa-download mr-2"></i>Export CSV
            </button>
            <button
              onclick="closeReports()"
              class="bg-gray-300 text-gray-700 px-6 py-3 rounded-lg font-medium hover:bg-gray-400 transition-colors"
            >
              Close
            </button>
          </div>
        </div>
      </div>

      <!-- Email Log Modal -->
      <div
        id="emailLogModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
      >
        <div
          class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-4xl slide-in max-h-[90vh] overflow-y-auto"
        >
          <div class="text-center mb-6">
            <i class="fas fa-envelope text-4xl text-blue-600 mb-4"></i>
            <h2 class="text-2xl font-bold text-gray-800">
              Email Notification Log
            </h2>
            <p class="text-gray-600">View all sent email notifications</p>
          </div>

          <div class="mb-4 flex justify-between items-center">
            <div class="flex space-x-2">
              <button
                onclick="clearEmailLog()"
                class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors"
              >
                <i class="fas fa-trash mr-2"></i>Clear Log
              </button>
              <button
                onclick="exportEmailLog()"
                class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors"
              >
                <i class="fas fa-download mr-2"></i>Export
              </button>
            </div>
            <div class="text-sm text-gray-600">
              <span id="emailLogCount">0</span> emails sent
            </div>
          </div>

          <div class="bg-gray-50 rounded-lg p-4 max-h-96 overflow-y-auto">
            <div id="emailLogContent" class="space-y-3">
              <!-- Email log entries will be populated here -->
            </div>
          </div>

          <div class="flex justify-end mt-6">
            <button
              onclick="closeEmailLog()"
              class="bg-gray-300 text-gray-700 px-6 py-3 rounded-lg font-medium hover:bg-gray-400 transition-colors"
            >
              Close
            </button>
          </div>
        </div>
      </div>

      <!-- Admin Dashboard -->
      <div id="adminDashboard" class="hidden min-h-screen bg-gray-50 overflow-x-hidden">
        <!-- Admin Header -->
        <header class="bg-white shadow-sm border-b">
          <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
              <div class="flex items-center">
                <i class="fas fa-shield-alt text-2xl text-red-600 mr-3"></i>
                <h1 class="text-xl font-semibold text-gray-900">
                  Admin Dashboard
                </h1>
                <div class="ml-4 flex items-center">
                  <span class="status-indicator status-online"></span>
                  <span class="sta-msg text-sm text-gray-600"
                    >Real-time sync active</span
                  >
                </div>
              </div>

              <div class="flex items-center space-x-4">
                <button 
                  onclick="generateDailyQR()"
                  class="qrgen bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                >
                  <i class="fas fa-qrcode mr-2"></i>Generate QR
                </button>

                <div class="relative">
                  <button
                    onclick="toggleUserMenu('admin')"
                    class="flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-100"
                  >
                    <div
                      id="adminAvatar"
                      class="w-8 h-8 bg-red-600 rounded-full flex items-center justify-center text-white text-sm font-medium"
                    >
                      AD
                    </div>
                    <span
                      id="adminName"
                      class="text-sm font-medium text-gray-700"
                      >Admin</span
                    >
                    <i class="fas fa-chevron-down text-xs text-gray-500"></i>
                  </button>

                  <div
                    id="adminUserMenu"
                    class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border z-10"
                  >
                    <div class="py-1">
                      <button
                        onclick="showProfile()"
                        class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                      >
                        <i class="fas fa-user mr-2"></i>Profile
                      </button>
                      <button
                        onclick="showSettings()"
                        class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                      >
                        <i class="fas fa-cog mr-2"></i>Settings
                      </button>
                      <hr class="my-1" />
                      <button
                        onclick="logout()"
                        class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100"
                      >
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </header>

        <!-- Admin Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
          <!-- Admin Stats -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-sm p-6 border">
              <div class="flex items-center">
                <div class="p-3 bg-blue-100 rounded-lg">
                  <i class="fas fa-users text-blue-600 text-xl"></i>
                </div>
                <div class="ml-4">
                  <p class="text-sm font-medium text-gray-600">Total Interns</p>
                  <p id="totalInterns" class="text-2xl font-bold text-gray-900">
                    17
                  </p>
                </div>
              </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-6 border">
              <div class="flex items-center">
                <div class="p-3 bg-green-100 rounded-lg">
                  <i class="fas fa-check-circle text-green-600 text-xl"></i>
                </div>
                <div class="ml-4">
                  <p class="text-sm font-medium text-gray-600">Present Today</p>
                  <p id="presentToday" class="text-2xl font-bold text-gray-900">
                    0
                  </p>
                </div>
              </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-6 border">
              <div class="flex items-center">
                <div class="p-3 bg-yellow-100 rounded-lg">
                  <i class="fas fa-clock text-yellow-600 text-xl"></i>
                </div>
                <div class="ml-4">
                  <p class="text-sm font-medium text-gray-600">
                    Currently Working
                  </p>
                  <p
                    id="currentlyWorking"
                    class="text-2xl font-bold text-gray-900"
                  >
                    0
                  </p>
                </div>
              </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-6 border">
              <div class="flex items-center">
                <div class="p-3 bg-red-100 rounded-lg">
                  <i class="fas fa-times-circle text-red-600 text-xl"></i>
                </div>
                <div class="ml-4">
                  <p class="text-sm font-medium text-gray-600">Absent Today</p>
                  <p id="absentToday" class="text-2xl font-bold text-gray-900">
                    0
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- QR Code & Quick Actions -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Daily QR Code -->
            <div class="bg-white rounded-xl shadow-sm p-6 border">
              <h3
                class="text-lg font-semibold text-gray-900 mb-4 flex items-center"
              >
                <i class="fas fa-qrcode text-blue-600 mr-2"></i>
                Today's QR Code
              </h3>

              <div class="text-center">
                <div id="dailyQRCode" class="bg-gray-50 rounded-lg p-8 mb-4">
                  <canvas id="qrCodeCanvas" class="mx-auto"></canvas>
                </div>

                <div class="text-sm text-gray-600 mb-4">
                  Valid until: <span class="font-medium">11:59 PM today</span>
                </div>

                <div class="flex space-x-2">
                  <button
                    onclick="generateDailyQR()"
                    class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors"
                  >
                    <i class="fas fa-refresh mr-2"></i>Regenerate
                  </button>
                  <button
                    onclick="downloadQR()"
                    class="flex-1 bg-gray-600 text-white py-2 rounded-lg hover:bg-gray-700 transition-colors"
                  >
                    <i class="fas fa-download mr-2"></i>Download
                  </button>
                </div>
              </div>
            </div>

            <!-- Quick Actions -->
            <div class="bg-white rounded-xl shadow-sm p-6 border">
              <h3
                class="text-lg font-semibold text-gray-900 mb-4 flex items-center"
              >
                <i class="fas fa-bolt text-yellow-600 mr-2"></i>
                Quick Actions
              </h3>

              <div class="space-y-3">
                <button
                  onclick="showAddIntern()"
                  class="w-full flex items-center p-3 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors"
                >
                  <i class="fas fa-user-plus text-blue-600 mr-3"></i>
                  <span class="text-blue-700 font-medium">Add New Intern</span>
                </button>

                <button
                  onclick="exportAttendance()"
                  class="w-full flex items-center p-3 bg-green-50 hover:bg-green-100 rounded-lg transition-colors"
                >
                  <i class="fas fa-file-export text-green-600 mr-3"></i>
                  <span class="text-green-700 font-medium"
                    >Export Attendance</span
                  >
                </button>

                <button
                  onclick="sendNotifications()"
                  class="w-full flex items-center p-3 bg-purple-50 hover:bg-purple-100 rounded-lg transition-colors"
                >
                  <i class="fas fa-bell text-purple-600 mr-3"></i>
                  <span class="text-purple-700 font-medium"
                    >Send Notifications</span
                  >
                </button>

                <button
                  onclick="viewReports()"
                  class="w-full flex items-center p-3 bg-orange-50 hover:bg-orange-100 rounded-lg transition-colors"
                >
                  <i class="fas fa-chart-bar text-orange-600 mr-3"></i>
                  <span class="text-orange-700 font-medium">View Reports</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Intern List -->
          <div class="bg-white rounded-xl shadow-sm border">
            <div class="p-6 border-b">
              <div class="block md:block lg:flex  justify-between items-center flex-wrap gap-4">
                <h3
                  class="py-3 text-lg font-semibold text-gray-900 flex items-center"
                >
                  <i class="fas fa-users text-indigo-600 mr-2"></i>
                  Intern Management
                </h3>

                <div class="block md:block lg:flex items-center flex-wrap gap-4">
                  <input
                    type="text"
                    id="searchInterns"
                    placeholder="Search interns..."
                    class="gap-4 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                  <select
                    id="filterDepartment"
                    class="gap-2 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  >
                    <option value="">All Departments</option>
                    <option value="engineering">Engineering</option>
                    <option value="marketing">Marketing</option>
                    <option value="hr">HR</option>
                    <option value="finance">Finance</option>
                    <option value="operations">Operations</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50">
                  <tr>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Intern
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Department
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Status
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Check-in
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Check-out
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Hours
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Actions
                    </th>
                  </tr>
                </thead>
                <tbody
                  id="internsList"
                  class="bg-white divide-y divide-gray-200"
                >
                  <tr>
                    <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                      <i class="fas fa-users text-2xl mb-2"></i>
                      <p>No interns found</p>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
      // Import Firebase modules
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import {
        getAuth,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signOut,
        sendPasswordResetEmail,
        onAuthStateChanged,
        GoogleAuthProvider,
        signInWithPopup,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import {
        getFirestore,
        doc,
        setDoc,
        getDoc,
        collection,
        addDoc,
        query,
        where,
        orderBy,
        onSnapshot,
        updateDoc,
        serverTimestamp,
        getDocs,
        documentId,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
      import {
        getFunctions,
        httpsCallable,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";

      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyClsVvQhA7JGNdtgTuxKVhLEkTPzg6iEr0",
        authDomain: "ticmark-485c6.firebaseapp.com",
        projectId: "ticmark-485c6",
        storageBucket: "ticmark-485c6.firebasestorage.app",
        messagingSenderId: "403974173327",
        appId: "1:403974173327:web:e8acedc468981a4be976fa",
        measurementId: "G-QBL5LCF0KG",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const analytics = getAnalytics(app);
      const functions = getFunctions(app);

      // Initialize Google Auth Provider
      const googleProvider = new GoogleAuthProvider();
      googleProvider.addScope("email");
      googleProvider.addScope("profile");

      // Make Firebase services available globally
      window.firebaseAuth = auth;
      window.firebaseDb = db;
      window.firebaseApp = app;

      // Push notification system
      async function initializePushNotifications() {
        if ("Notification" in window && "serviceWorker" in navigator) {
          try {
            const permission = await Notification.requestPermission();
            if (permission === "granted") {
              console.log("Push notifications enabled");
              localStorage.setItem("notificationsEnabled", "true");
            } else {
              console.log("Push notifications denied");
              localStorage.setItem("notificationsEnabled", "false");
            }
          } catch (error) {
            console.error("Error initializing push notifications:", error);
          }
        }
      }

      // Send push notification
      function sendPushNotification(title, body, icon = "/favicon.ico") {
        if (
          Notification.permission === "granted" &&
          localStorage.getItem("notificationsEnabled") === "true"
        ) {
          try {
            const notification = new Notification(title, {
              body: body,
              icon: icon,
              badge: icon,
              tag: "attendance-notification",
              requireInteraction: false,
              silent: false,
            });

            notification.onclick = function () {
              window.focus();
              notification.close();
            };

            // Auto close after 5 seconds
            setTimeout(() => notification.close(), 5000);
          } catch (error) {
            console.error("Error sending push notification:", error);
          }
        }
      }

      // Email notification system
      async function sendEmailNotification(to, subject, body, type = "info") {
        try {
          const sendEmail = httpsCallable(functions, "sendEmail");
          const result = await sendEmail({ to, subject, body });

          if (result.data.success) {
            showNotification(`Email sent to ${to}`, "success");

            // Log the email
            const emailLog = JSON.parse(
              localStorage.getItem("emailLog") || "[]"
            );
            emailLog.push({
              to,
              subject,
              body,
              type,
              timestamp: Date.now(),
              status: "sent",
            });
            localStorage.setItem("emailLog", JSON.stringify(emailLog));

            return { success: true, messageId: Date.now().toString() };
          } else {
            showNotification("Failed to send email", "error");
            return { success: false, error: result.data.error };
          }
        } catch (err) {
          showNotification("Failed to send email", "error");
          return { success: false, error: err.message };
        } finally {
          hideLoading();
        }
      }

      // Global state
      window.currentUser = null;
      window.userRole = null;
      window.isLocationVerified = true;
      window.qrStream = null;
      window.currentAttendanceSession = null;
      window.workingHoursTimer = null;
      window.attendanceListeners = [];

      // Error handling utility
      function handleFirebaseError(error) {
        console.error("Firebase Error:", error);
        let message = "An error occurred. Please try again.";

        switch (error.code) {
          case "auth/user-not-found":
            message = "No account found with this email address.";
            break;
          case "auth/wrong-password":
            message = "Incorrect password. Please try again.";
            break;
          case "auth/email-already-in-use":
            message = "An account with this email already exists.";
            break;
          case "auth/weak-password":
            message = "Password should be at least 6 characters long.";
            break;
          case "auth/invalid-email":
            message = "Please enter a valid email address.";
            break;
          case "auth/network-request-failed":
            message = "Network error. Please check your connection.";
            break;
          case "permission-denied":
            message = "You do not have permission to perform this action.";
            break;
          case "unavailable":
            message =
              "Service temporarily unavailable. Please try again later.";
            break;
        }

        showNotification(message, "error");
        return message;
      }

      // Auth state observer with persistence
      onAuthStateChanged(auth, async (user) => {
        console.log(
          "Auth state changed:",
          user ? "User logged in" : "User logged out"
        );

        if (user) {
          try {
            showLoading();
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (userDoc.exists()) {
              const userData = userDoc.data();
              window.currentUser = {
                uid: user.uid,
                email: user.email,
                photoURL: user.photoURL,
                displayName: user.displayName,
                ...userData,
              };
              window.userRole = userData.role;

              // Save to localStorage for persistence
              localStorage.setItem(
                "currentUser",
                JSON.stringify(window.currentUser)
              );
              localStorage.setItem("userRole", userData.role);
              localStorage.setItem("lastLoginTime", Date.now().toString());

              // Check if profile completion is needed
              if (userData.needsProfileCompletion) {
                hideLoading();
                showProfileCompletion(userData);
                return;
              }

              // Initialize push notifications
              await initializePushNotifications();

              if (userData.role === "admin") {
                showAdminDashboard();
                updateUserUI(
                  userData.firstName + " " + userData.lastName,
                  userData.photoURL || "AD"
                );
                await loadAdminData();
              } else {
                showInternDashboard();
                updateUserUI(
                  userData.firstName + " " + userData.lastName,
                  userData.photoURL ||
                    userData.firstName.charAt(0) + userData.lastName.charAt(0)
                );
                await loadInternData();
              }

              showNotification(
                `Welcome back, ${userData.firstName}!`,
                "success"
              );
            } else {
              // User document doesn't exist, sign out
              await signOut(auth);
            }
          } catch (error) {
            console.error("Auth state error:", error);
            handleFirebaseError(error);
          } finally {
            hideLoading();
          }
        } else {
          // User logged out - clear everything
          window.currentUser = null;
          window.userRole = null;
          localStorage.removeItem("currentUser");
          localStorage.removeItem("userRole");
          localStorage.removeItem("lastLoginTime");

          // Clean up listeners
          window.attendanceListeners.forEach((unsubscribe) => unsubscribe());
          window.attendanceListeners = [];

          // Stop timers
          stopWorkingHoursTimer();

          showLanding();
        }
      });

      // User registration
      async function registerUser(email, password, userData) {
        try {
          showLoading();
          const userCredential = await createUserWithEmailAndPassword(
            auth,
            email,
            password
          );
          const user = userCredential.user;

          // Save user data to Firestore
          await setDoc(doc(db, "users", user.uid), {
            ...userData,
            role: "intern", // Default role
            createdAt: serverTimestamp(),
            isActive: true,
          });

          showNotification("Account created successfully!", "success");
          return user;
        } catch (error) {
          handleFirebaseError(error);
          throw error;
        } finally {
          hideLoading();
        }
      }

      // User login
      async function loginUser(email, password) {
        try {
          showLoading();
          const userCredential = await signInWithEmailAndPassword(
            auth,
            email,
            password
          );
          showNotification("Login successful!", "success");
          return userCredential.user;
        } catch (error) {
          handleFirebaseError(error);
          throw error;
        } finally {
          hideLoading();
        }
      }

      // Password reset
      async function resetPassword(email) {
        try {
          showLoading();
          await sendPasswordResetEmail(auth, email);
          showNotification("Password reset email sent!", "success");
        } catch (error) {
          handleFirebaseError(error);
          throw error;
        } finally {
          hideLoading();
        }
      }

      // Google Sign In
      async function signInWithGoogle(role = "intern") {
        try {
          showLoading();
          const result = await signInWithPopup(auth, googleProvider);
          const user = result.user;

          // Check if user exists in Firestore
          const userDoc = await getDoc(doc(db, "users", user.uid));

          if (!userDoc.exists()) {
            // New user - create profile with role selection
            const userData = {
              firstName: user.displayName?.split(" ")[0] || "User",
              lastName: user.displayName?.split(" ").slice(1).join(" ") || "",
              email: user.email,
              employeeId: `EMP${Date.now()}`, // Auto-generate employee ID
              department: "", // Will be set in profile completion
              role: role,
              photoURL: user.photoURL,
              createdAt: serverTimestamp(),
              isActive: true,
              needsProfileCompletion: true,
              authProvider: "google",
            };

            await setDoc(doc(db, "users", user.uid), userData);

            // Show profile completion modal for new users
            if (role === "intern") {
              showProfileCompletion(userData);
            } else {
              showNotification(
                "Admin account created! Please complete your profile.",
                "success"
              );
            }
          } else {
            // Existing user - verify role matches
            const existingData = userDoc.data();
            if (existingData.role !== role) {
              await signOut(auth);
              showNotification(
                `This account is registered as ${existingData.role}. Please use the correct login portal.`,
                "error"
              );
              return;
            }

            showNotification("Google sign-in successful!", "success");
          }

          return user;
        } catch (error) {
          if (error.code === "auth/popup-closed-by-user") {
            showNotification("Sign-in cancelled", "warning");
          } else if (error.code === "auth/popup-blocked") {
            showNotification(
              "Popup blocked. Please allow popups and try again.",
              "error"
            );
          } else {
            handleFirebaseError(error);
          }
          throw error;
        } finally {
          hideLoading();
        }
      }

      // Complete Google user profile
      async function completeGoogleProfile(profileData) {
        if (!window.currentUser) return;

        try {
          showLoading();

          const userRef = doc(db, "users", window.currentUser.uid);
          await updateDoc(userRef, {
            ...profileData,
            needsProfileCompletion: false,
            updatedAt: serverTimestamp(),
          });

          // Update local user data
          window.currentUser = { ...window.currentUser, ...profileData };

          showNotification("Profile completed successfully!", "success");
          closeProfileCompletion();
          if (window.userRole === "intern") {
            showInternDashboard();
          } else {
            showAdminDashboard();
          }
        } catch (error) {
          handleFirebaseError(error);
        } finally {
          hideLoading();
        }
      }

      // Attendance functions
      async function checkIn() {
        if (!window.currentUser) return;

        try {
          showLoading();
          const now = new Date();
          const today = now.toDateString();

          // Check today's attendance
          const attendanceQuery = query(
            collection(db, "attendance"),
            where("userId", "==", window.currentUser.uid),
            where("date", "==", today)
          );
          const existingAttendance = await getDocs(attendanceQuery);

          if (!existingAttendance.empty) {
            const attendanceData = existingAttendance.docs[0].data();

            // Already checked in but not checked out → deny new check-in
            if (attendanceData.checkInTime && !attendanceData.checkOutTime) {
              showNotification("You are already checked in!", "warning");
              return;
            }

            // Already checked in and checked out → cannot check in again
            if (attendanceData.checkInTime && attendanceData.checkOutTime) {
              showNotification("You have already checked out today!", "info");
              return;
            }
          }

          // Validate location
          const accessCheck = await checkStudentAccess();
          if (!accessCheck.access) {
            showNotification(`Access denied: ${accessCheck.reason}`, "error");
            return;
          }

          const location = await getCurrentLocation();

          // Create attendance record
          const attendanceData = {
            userId: window.currentUser.uid,
            userEmail: window.currentUser.email,
            userName: `${window.currentUser.firstName} ${window.currentUser.lastName}`,
            department: window.currentUser.department,
            date: today,
            checkInTime: serverTimestamp(),
            checkInLocation: location,
            status: "checked-in",
            createdAt: serverTimestamp(),
          };

          await addDoc(collection(db, "attendance"), attendanceData);

          window.currentAttendanceSession = { checkInTime: Date.now() };
          updateAttendanceButtons("checked-in");
          updateCurrentStatus("checked-in", now.toLocaleTimeString());
          startWorkingHoursTimer();
          addRecentActivity("Checked in", now.toLocaleString());

          sendPushNotification("Attendance Update", "Successfully checked in!");
          showNotification("Checked in successfully!", "success");
        } catch (error) {
          handleFirebaseError(error);
        } finally {
          hideLoading();
        }
      }

      async function checkOut() {
        if (!window.currentUser) return;

        try {
          showLoading();
          const now = new Date();
          const today = now.toDateString();

          // Find today's attendance
          const attendanceQuery = query(
            collection(db, "attendance"),
            where("userId", "==", window.currentUser.uid),
            where("date", "==", today)
          );
          const existingAttendance = await getDocs(attendanceQuery);

          if (existingAttendance.empty) {
            showNotification("You haven't checked in today!", "warning");
            return;
          }

          const attendanceDoc = existingAttendance.docs[0];
          const attendanceRef = doc(db, "attendance", attendanceDoc.id);
          const attendanceData = attendanceDoc.data();

          if (!attendanceData.checkInTime) {
            showNotification("You haven't checked in today!", "warning");
            return;
          }

          if (attendanceData.checkOutTime) {
            showNotification("You have already checked out!", "info");
            return;
          }

          // Validate location before checkout
          const accessCheck = await checkStudentAccess();
          if (!accessCheck.access) {
            showNotification(`Checkout denied: ${accessCheck.reason}`, "error");
            return;
          }

          const location = await getCurrentLocation();

          // Calculate working hours
          const checkInTime = attendanceData.checkInTime.toDate();
          const workingHours = (now - checkInTime) / (1000 * 60 * 60);

          // Update checkout info
          await updateDoc(attendanceRef, {
            checkOutTime: serverTimestamp(),
            checkOutLocation: location,
            status: "checked-out",
            workingHours: workingHours,
            updatedAt: serverTimestamp(),
          });

          updateAttendanceButtons("checked-out");
          updateCurrentStatus("checked-out", now.toLocaleTimeString());
          updateWorkingHours(workingHours);
          stopWorkingHoursTimer();
          window.currentAttendanceSession = null;
          addRecentActivity("Checked out", now.toLocaleString());

          sendPushNotification(
            "Attendance Update",
            "Successfully checked out!"
          );
          showNotification("Checked out successfully!", "success");
        } catch (error) {
          handleFirebaseError(error);
        } finally {
          hideLoading();
        }
      }

      // Location services
      // Company fixed location (example)
      const companyLocation = {
        latitude: 3.860987,                                                                                               
        longitude: 11.498647,
      };

      // Haversine formula to calculate distance in km
      function haversineDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // Earth radius in km
        const toRad = (deg) => (deg * Math.PI) / 180;

        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);

        const a =
          Math.sin(dLat / 2) ** 2 +
          Math.cos(toRad(lat1)) *
            Math.cos(toRad(lat2)) *
            Math.sin(dLon / 2) ** 2;

        const c = 2 * Math.asin(Math.sqrt(a));

        return R * c; // Distance in km
      }

      // Location services with validation
      async function checkStudentAccess() {
        const studentLocation = await getCurrentLocation();
        const locationMessage = document.getElementById("locationMessage");
        const locationDistance = document.getElementById("locationDistance");

        if (!studentLocation.latitude || !studentLocation.longitude) {
          console.warn("Unable to fetch location:", studentLocation.error);
          return { access: false, reason: "Location not available" };
        }

        // Calculate distance

        const distance = haversineDistance(
          studentLocation.latitude,
          studentLocation.longitude,
          companyLocation.latitude,
          companyLocation.longitude
        );

        if (locationMessage) {
          locationMessage.textContent = `You are ${distance.toFixed(
            2
          )} km away from company`;
        }

        if (locationDistance) {
          locationDistance.textContent = `Accuracy: ${studentLocation.accuracy.toFixed(
            1
          )}m`;
        }

        if (distance <= 3) {
          return { access: true, reason: "Within safe boundary" };
        } else {
          return {
            access: false,
            reason: `Outside safe boundary  with ${distance.toFixed(2)}km`,
          };
        }
      }
      function getCurrentLocation() {
        return new Promise((resolve) => {
          if (!navigator.geolocation) {
            resolve({ error: "Geolocation not supported" });
            return;
          }

          navigator.geolocation.getCurrentPosition(
            (position) => {
              resolve({
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
                accuracy: position.coords.accuracy,
              });
            },
            (error) => {
              resolve({ error: error.message });
            },
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
          );
        });
      }
      // Load intern dashboard data
      // Load intern dashboard data in real-time
      async function loadInternData() {
        if (!window.currentUser) return;

        const today = new Date().toDateString();

        // Listen for today's attendance changes
        const attendanceQueryToday = query(
          collection(db, "attendance"),
          where("userId", "==", window.currentUser.uid),
          where("date", "==", today)
        );

        const unsubscribeToday = onSnapshot(
          attendanceQueryToday,
          (snapshot) => {
            if (!snapshot.empty) {
              const attendanceData = snapshot.docs[0].data();
              if (attendanceData.status === "checked-in") {
                window.currentAttendanceSession = {
                  checkInTime: attendanceData.checkInTime.toDate().getTime(),
                };
                updateAttendanceButtons("checked-in");
                updateCurrentStatus(
                  "checked-in",
                  attendanceData.checkInTime.toDate().toLocaleTimeString()
                );
                startWorkingHoursTimer();
              } else if (attendanceData.status === "checked-out") {
                updateAttendanceButtons("checked-out");
                updateCurrentStatus(
                  "checked-out",
                  attendanceData.checkOutTime.toDate().toLocaleTimeString()
                );
                stopWorkingHoursTimer();
                window.currentAttendanceSession = null;
              }
            } else {
              updateAttendanceButtons("not-checked-in");
              updateCurrentStatus("not-checked-in", "--");
            }
          }
        );
        window.attendanceListeners.push(unsubscribeToday);

        // Load monthly stats in real-time
        loadMonthlyStats();

        // Load recent activity in real-time
        loadRecentActivity();
      }

      // Load monthly statistics
      function loadMonthlyStats() {
        if (!window.currentUser) return;

        const now = new Date();
        const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
        const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);

        const attendanceQuery = query(
          collection(db, "attendance"),
          where("userId", "==", window.currentUser.uid),
          where("createdAt", ">=", firstDay),
          where("createdAt", "<=", lastDay)
        );

        const unsubscribeMonthly = onSnapshot(attendanceQuery, (snapshot) => {
          const attendanceData = snapshot.docs.map((doc) => doc.data());

          const totalDays = attendanceData.length;
          const workingDays = lastDay.getDate();
          const avgHours =
            attendanceData.reduce(
              (sum, record) => sum + (record.workingHours || 0),
              0
            ) / totalDays || 0;
          const lateDays = attendanceData.filter((record) => {
            if (record.checkInTime) {
              const checkInHour = record.checkInTime.toDate().getHours();
              return checkInHour > 9; // 9 AM standard
            }
            return false;
          }).length;

          document.getElementById(
            "monthlyAttendance"
          ).textContent = `${totalDays}/${workingDays}`;
          document.getElementById("avgHours").textContent = `${avgHours.toFixed(
            1
          )}h`;
          document.getElementById("lateDays").textContent = lateDays;
          document.getElementById("streak").textContent = `${Math.min(
            totalDays,
            5
          )} days`;
        });
        window.attendanceListeners.push(unsubscribeMonthly);
      }

      // Load recent activity
      function loadRecentActivity() {
        if (!window.currentUser) return;

        const attendanceQuery = query(
          collection(db, "attendance"),
          where("userId", "==", window.currentUser.uid),
          orderBy("createdAt", "desc")
        );

        const unsubscribeRecent = onSnapshot(attendanceQuery, (snapshot) => {
          const activityContainer = document.getElementById("recentActivity");
          activityContainer.innerHTML = "";

          if (snapshot.empty) {
            activityContainer.innerHTML = `
        <div class="text-center text-gray-500 py-8">
          <i class="fas fa-clock text-2xl mb-2"></i>
          <p>No recent activity</p>
        </div>
      `;
            return;
          }

          snapshot.docs.forEach((doc) => {
            const data = doc.data();
            const activity = document.createElement("div");
            activity.className =
              "flex items-center space-x-3 p-3 bg-gray-50 rounded-lg";

            const isCheckIn =
              data.status === "checked-in" ||
              (data.checkInTime && !data.checkOutTime);
            const time = isCheckIn ? data.checkInTime : data.checkOutTime;
            const action = isCheckIn ? "Checked in" : "Checked out";
            const color = isCheckIn ? "green" : "orange";

            activity.innerHTML = `
        <div class="w-2 h-2 bg-${color}-500 rounded-full"></div>
        <div class="flex-1">
          <p class="text-sm font-medium text-gray-900">${action}</p>
          <p class="text-xs text-gray-500">${
            time ? time.toDate().toLocaleDateString() : "Unknown"
          }</p>
        </div>
      `;
            activityContainer.appendChild(activity);
          });
        });
        window.attendanceListeners.push(unsubscribeRecent);
      }

      // Load admin dashboard data
      async function loadAdminData() {
        if (!window.currentUser || window.userRole !== "admin") return;

        // Track all unsubscribe functions to clean up listeners
        window.adminListeners = window.adminListeners || [];
        window.adminListeners.forEach((unsub) => unsub());
        window.adminListeners = [];

        // Listen for all interns
        const usersQuery = query(
          collection(db, "users"),
          where("role", "==", "intern")
        );

        const unsubscribeUsers = onSnapshot(usersQuery, (snapshot) => {
          const totalInterns = snapshot.size;
          document.getElementById("totalInterns").textContent = totalInterns;

          loadInternsList(); // update the interns table
        });
        window.adminListeners.push(unsubscribeUsers);

        // Listen for today's attendance
        const today = new Date().toDateString();
        const attendanceQuery = query(
          collection(db, "attendance"),
          where("date", "==", today)
        );

        const unsubscribeAttendance = onSnapshot(
          attendanceQuery,
          (snapshot) => {
            const presentToday = snapshot.size;
            const currentlyWorking = snapshot.docs.filter(
              (doc) => doc.data().status === "checked-in"
            ).length;

            const totalInternsEl =
              document.getElementById("totalInterns").textContent;
            const totalInterns = totalInternsEl ? parseInt(totalInternsEl) : 0;
            const absentToday = totalInterns - presentToday;

            document.getElementById("presentToday").textContent = presentToday;
            document.getElementById("currentlyWorking").textContent =
              currentlyWorking;
            document.getElementById("absentToday").textContent = absentToday;

            loadInternsList(); // Refresh table on attendance change
          }
        );
        window.adminListeners.push(unsubscribeAttendance);
      }

      // Real-time listeners
      async function loadInternsList() {
        const internsList = document.getElementById("internsList");
        if (!internsList) return;

        const auth = window.firebaseAuth;
        const db = window.firebaseDb;

        const user = auth.currentUser;
        if (!user) return console.log("No user logged in") && (internsList.innerHTML = "");

        const tokenResult = await user.getIdTokenResult();
        console.log(tokenResult)
        if(!tokenResult) {
          return internsList.innerHTML = `
            <tr>
              <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                <i class="fas fa-users text-2xl mb-2"></i>
                <p>Access denied</p>
              </td>
            </tr>
          `;
        }
        
        const isAdmin = tokenResult.claims.role === "admin";

        let usersQuery;
        if (isAdmin) {
          usersQuery = query(
            collection(db, "users"),
            where("role", "==", "intern")
          );
        } else {
          usersQuery = query(
            collection(db, "users"),
            where("role", "==", "intern"),
            where(documentId(), "==", user.uid)
          );
        }

        const unsubscribe = onSnapshot(usersQuery, async (snapshot) => {
          internsList.innerHTML = "";
          const today = new Date().toDateString();

          if (snapshot.empty) {
            internsList.innerHTML = `
        <tr>
          <td colspan="7" class="px-6 py-8 text-center text-gray-500">
            <i class="fas fa-users text-2xl mb-2"></i>
            <p>No interns found</p>
          </td>
        </tr>
      `;
            return;
          }

          for (const userDoc of snapshot.docs) {
            const userData = userDoc.data();

            // Listen for today's attendance for this user
            const attendanceQuery = query(
              collection(db, "attendance"),
              where("userId", "==", userDoc.id),
              where("date", "==", today)
            );

            const attendanceSnap = await getDocs(attendanceQuery);
            let status = "Absent";
            let statusClass = "status-offline";
            let checkIn = "--";
            let checkOut = "--";
            let hours = "0h";

            if (!attendanceSnap.empty) {
              const attendanceData = attendanceSnap.docs[0].data();
              if (attendanceData.status === "checked-in") {
                status = "Working";
                statusClass = "status-online";
              } else if (attendanceData.status === "checked-out") {
                status = "Completed";
                statusClass = "status-away";
              }

              if (attendanceData.checkInTime)
                checkIn = attendanceData.checkInTime
                  .toDate()
                  .toLocaleTimeString("en-US", {
                    hour: "2-digit",
                    minute: "2-digit",
                  });
              if (attendanceData.checkOutTime)
                checkOut = attendanceData.checkOutTime
                  .toDate()
                  .toLocaleTimeString("en-US", {
                    hour: "2-digit",
                    minute: "2-digit",
                  });
              if (attendanceData.workingHours)
                hours = `${attendanceData.workingHours.toFixed(1)}h`;
            }

            const row = document.createElement("tr");
            row.innerHTML = `
        <td class="px-6 py-4 whitespace-nowrap">
          <div class="flex items-center">
            <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center text-white font-medium">
              ${userData.firstName.charAt(0)}${userData.lastName.charAt(0)}
            </div>
            <div class="ml-4">
              <div class="text-sm font-medium text-gray-900">
                ${userData.firstName} ${userData.lastName}
              </div>
              <div class="text-sm text-gray-500">${userData.email}</div>
            </div>
          </div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
          <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
            ${userData.department}
          </span>
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
          <span class="flex items-center">
            <span class="status-indicator ${statusClass}"></span>
            <span class="text-sm text-gray-900">${status}</span>
          </span>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${checkIn}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${checkOut}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${hours}</td>
        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
          ${
            isAdmin
              ? `<button class="text-indigo-600 hover:text-indigo-900 mr-3">Edit</button>
          <button class="text-red-600 hover:text-red-900">Remove</button>`
              : ""
          }
        </td>
      `;
            internsList.appendChild(row);
          }
        });

        window.adminListeners.push(unsubscribe);
      }

      // Add new intern function
      async function addNewIntern(userData, password) {
        try {
          showLoading();

          // Create user account
          const userCredential = await createUserWithEmailAndPassword(
            auth,
            userData.email,
            password
          );
          const user = userCredential.user;

          // Save user data to Firestore
          await setDoc(doc(db, "users", user.uid), {
            ...userData,
            role: "intern",
            createdAt: serverTimestamp(),
            isActive: true,
            needsPasswordChange: true,
          });

          showNotification("Intern added successfully!", "success");
          closeAddIntern();
          loadAdminData();
        } catch (error) {
          handleFirebaseError(error);
        } finally {
          hideLoading();
        }
      }

      function setupRealTimeListeners() {
        if (!window.currentUser) return;

        // Clean up existing listeners
        window.attendanceListeners.forEach((unsubscribe) => unsubscribe());
        window.attendanceListeners = [];

        if (window.userRole === "admin") {
          // Admin real-time listeners
          const usersQuery = query(
            collection(db, "users"),
            where("role", "==", "intern")
          );
          const unsubscribeUsers = onSnapshot(usersQuery, (snapshot) => {
            loadAdminData();
          });
          window.attendanceListeners.push(unsubscribeUsers);

          const today = new Date().toDateString();
          const attendanceQuery = query(
            collection(db, "attendance"),
            where("date", "==", today)
          );
          const unsubscribeAttendance = onSnapshot(
            attendanceQuery,
            (snapshot) => {
              loadAdminData();
              loadInternsList();
            }
          );
          window.attendanceListeners.push(unsubscribeAttendance);
        } else {
          // Intern real-time listeners
          const today = new Date().toDateString();
          const attendanceQuery = query(
            collection(db, "attendance"),
            where("userId", "==", window.currentUser.uid),
            where("date", "==", today)
          );
          const unsubscribeAttendance = onSnapshot(
            attendanceQuery,
            (snapshot) => {
              if (!snapshot.empty) {
                const attendanceData = snapshot.docs[0].data();
                if (
                  attendanceData.status === "checked-in" &&
                  !window.currentAttendanceSession
                ) {
                  window.currentAttendanceSession = {
                    checkInTime: attendanceData.checkInTime.toDate().getTime(),
                  };
                  updateAttendanceButtons("checked-in");
                  updateCurrentStatus(
                    "checked-in",
                    attendanceData.checkInTime.toDate().toLocaleTimeString()
                  );
                  startWorkingHoursTimer();
                }
              }
            }
          );
          window.attendanceListeners.push(unsubscribeAttendance);

          // Listen for user profile updates
          const userDocRef = doc(db, "users", window.currentUser.uid);
          const unsubscribeUser = onSnapshot(userDocRef, (doc) => {
            if (doc.exists()) {
              const userData = doc.data();
              window.currentUser = { ...window.currentUser, ...userData };
              updateUserUI(
                userData.firstName + " " + userData.lastName,
                userData.firstName.charAt(0) + userData.lastName.charAt(0)
              );
            }
          });
          window.attendanceListeners.push(unsubscribeUser);
        }
      }

      // Update user profile
      async function updateUserProfile(profileData) {
        if (!window.currentUser) return;

        try {
          showLoading();

          const userRef = doc(db, "users", window.currentUser.uid);
          await updateDoc(userRef, {
            firstName: profileData.firstName,
            lastName: profileData.lastName,
            department: profileData.department,
            updatedAt: serverTimestamp(),
          });

          // Update local user data
          window.currentUser.firstName = profileData.firstName;
          window.currentUser.lastName = profileData.lastName;
          window.currentUser.department = profileData.department;

          showNotification("Profile updated successfully!", "success");
          closeProfile();
        } catch (error) {
          handleFirebaseError(error);
        } finally {
          hideLoading();
        }
      }

      // Export attendance data
      async function exportAttendanceData() {
        try {
          showLoading();

          const startDate = new Date();
          startDate.setMonth(startDate.getMonth() - 1);

          const attendanceQuery = query(
            collection(db, "attendance"),
            where("createdAt", ">=", startDate),
            orderBy("createdAt", "desc")
          );

          const attendanceDocs = await getDocs(attendanceQuery);

          if (attendanceDocs.empty) {
            showNotification("No attendance data to export", "warning");
            return;
          }

          // Prepare CSV data
          const csvData = [];
          csvData.push([
            "Date",
            "Employee Name",
            "Employee ID",
            "Department",
            "Check In",
            "Check Out",
            "Working Hours",
            "Status",
          ]);

          attendanceDocs.forEach((doc) => {
            const data = doc.data();
            csvData.push([
              data.date || "",
              data.userName || "",
              data.userEmail || "",
              data.department || "",
              data.checkInTime
                ? data.checkInTime.toDate().toLocaleString()
                : "",
              data.checkOutTime
                ? data.checkOutTime.toDate().toLocaleString()
                : "",
              data.workingHours ? data.workingHours.toFixed(2) + "h" : "",
              data.status || "",
            ]);
          });

          // Create and download CSV
          const csvContent = csvData.map((row) => row.join(",")).join("\n");
          const blob = new Blob([csvContent], { type: "text/csv" });
          const url = window.URL.createObjectURL(blob);
          const link = document.createElement("a");
          link.href = url;
          link.download = `attendance-report-${
            new Date().toISOString().split("T")[0]
          }.csv`;
          link.click();
          window.URL.revokeObjectURL(url);

          showNotification("Attendance data exported successfully!", "success");
        } catch (error) {
          handleFirebaseError(error);
        } finally {
          hideLoading();
        }
      }

      async function sendNotifications() {
        if (!window.currentUser || window.userRole !== "admin") {
          showNotification("Access denied", "error");
          return;
        }

        try {
          showLoading();

          // Get all interns
          const usersQuery = query(
            collection(window.firebaseDb, "users"),
            where("role", "==", "intern")
          );
          const usersDocs = await getDocs(usersQuery);

          if (usersDocs.empty) {
            showNotification("No interns found to notify", "warning");
            return;
          }

          const today = new Date().toDateString();
          const currentTime = new Date().toLocaleTimeString();

          // Check who hasn't checked in today
          const attendanceQuery = query(
            collection(window.firebaseDb, "attendance"),
            where("date", "==", today)
          );
          const attendanceDocs = await getDocs(attendanceQuery);
          const checkedInUserIds = attendanceDocs.docs.map(
            (doc) => doc.data().userId
          );

          let notificationsSent = 0;

          // Send notifications to interns who haven't checked in
          for (const userDoc of usersDocs.docs) {
            const userData = userDoc.data();

            if (!checkedInUserIds.includes(userDoc.id)) {
              // Send email reminder
              await sendEmailNotification(
                userData.email,
                "Attendance Reminder - AttendanceHub",
                `Hello ${userData.firstName},\n\nThis is a friendly reminder to check in for today (${today}).\n\nCurrent time: ${currentTime}\n\nPlease log in to AttendanceHub and mark your attendance.\n\nBest regards,\nAttendanceHub Admin Team`,
                "reminder"
              );

              notificationsSent++;

              // Small delay to avoid overwhelming the system
              await new Promise((resolve) => setTimeout(resolve, 500));
            }
          }

          // Send summary notification to admin
          sendPushNotification(
            "Notifications Sent",
            `Sent ${notificationsSent} attendance reminders to interns who haven't checked in today.`
          );

          showNotification(
            `Sent ${notificationsSent} attendance reminders successfully!`,
            "success"
          );
        } catch (error) {
          console.error("Error sending notifications:", error);
          showNotification("Error sending notifications", "error");
        } finally {
          hideLoading();
        }
      }

      // Make functions available globally
      window.registerUser = registerUser;
      window.loginUser = loginUser;
      window.resetPassword = resetPassword;
      window.signInWithGoogle = signInWithGoogle;
      window.completeGoogleProfile = completeGoogleProfile;
      window.checkIn = checkIn;
      window.checkOut = checkOut;
      window.loadInternData = loadInternData;
      window.loadAdminData = loadAdminData;
      window.setupRealTimeListeners = setupRealTimeListeners;
      window.addNewIntern = addNewIntern;
      window.updateUserProfile = updateUserProfile;
      window.exportAttendanceData = exportAttendanceData;
      window.initializePushNotifications = initializePushNotifications;
      window.sendPushNotification = sendPushNotification;
      window.sendEmailNotification = sendEmailNotification;
      window.sendNotifications = sendNotifications;
    </script>

    <script>
      // Navigation functions
      function showLanding() {
        hideAllPages();
        document.getElementById("landingPage").classList.remove("hidden");
      }

      function showLogin(role) {
        hideAllPages();
        document.getElementById("loginPage").classList.remove("hidden");
        window.userRole = role;

        const title = document.getElementById("loginTitle");
        const subtitle = document.getElementById("loginSubtitle");

        if (role === "admin") {
          title.textContent = "Admin Login";
          subtitle.textContent = "Access admin dashboard";
        } else {
          title.textContent = "Intern Login";
          subtitle.textContent = "Access your dashboard";
        }
      }

      function showSignup() {
        hideAllPages();
        document.getElementById("signupPage").classList.remove("hidden");
      }

      function showForgotPassword() {
        hideAllPages();
        document
          .getElementById("forgotPasswordPage")
          .classList.remove("hidden");
      }

      function hideAllPages() {
        const pages = [
          "landingPage",
          "loginPage",
          "signupPage",
          "forgotPasswordPage",
          "internDashboard",
          "adminDashboard",
        ];
        pages.forEach((page) => {
          document.getElementById(page).classList.add("hidden");
        });
      }

      function showInternDashboard() {
        hideAllPages();
        document.getElementById("internDashboard").classList.remove("hidden");
        generateCalendar();
        updateTime();
        setInterval(updateTime, 1000);
        window.loadInternData();
        window.setupRealTimeListeners();
      }

      function showAdminDashboard() {
        hideAllPages();
        document.getElementById("adminDashboard").classList.remove("hidden");
        generateDailyQR();
        window.loadAdminData();
        window.setupRealTimeListeners();
      }

      // Form handlers
      document
        .getElementById("loginForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          clearFormErrors();

          const email = document.getElementById("loginEmail").value.trim();
          const password = document.getElementById("loginPassword").value;

          if (!validateEmail(email)) {
            showFieldError(
              "loginEmailError",
              "Please enter a valid email address"
            );
            return;
          }

          if (!password) {
            showFieldError("loginPasswordError", "Password is required");
            return;
          }

          try {
            await window.loginUser(email, password);
            clearAutoSave("loginForm"); // Clear auto-saved data on successful login
          } catch (error) {
            // Error is already handled in loginUser function
          }
        });

      document
        .getElementById("signupForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          clearFormErrors();

          const firstName = document.getElementById("firstName").value.trim();
          const lastName = document.getElementById("lastName").value.trim();
          const email = document.getElementById("signupEmail").value.trim();
          const employeeId = document.getElementById("employeeId").value.trim();
          const department = document.getElementById("department").value;
          const password = document.getElementById("signupPassword").value;

          let hasErrors = false;

          if (!firstName) {
            showFieldError("firstNameError", "First name is required");
            hasErrors = true;
          }

          if (!lastName) {
            showFieldError("lastNameError", "Last name is required");
            hasErrors = true;
          }

          if (!validateEmail(email)) {
            showFieldError(
              "signupEmailError",
              "Please enter a valid email address"
            );
            hasErrors = true;
          }

          if (!employeeId) {
            showFieldError("employeeIdError", "Employee ID is required");
            hasErrors = true;
          }

          if (!department) {
            showFieldError("departmentError", "Please select a department");
            hasErrors = true;
          }

          if (!validatePassword(password)) {
            showFieldError(
              "signupPasswordError",
              "Password must be at least 8 characters with uppercase, lowercase, and number"
            );
            hasErrors = true;
          }

          if (hasErrors) return;

          const userData = {
            firstName,
            lastName,
            email,
            employeeId,
            department,
          };

          try {
            await window.registerUser(email, password, userData);
            clearAutoSave("signupForm"); // Clear auto-saved data on successful signup
          } catch (error) {
            // Error is already handled in registerUser function
          }
        });

      document
        .getElementById("forgotPasswordForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          clearFormErrors();

          const email = document.getElementById("resetEmail").value.trim();

          if (!validateEmail(email)) {
            showFieldError(
              "resetEmailError",
              "Please enter a valid email address"
            );
            return;
          }

          try {
            await window.resetPassword(email);
            setTimeout(() => showLogin("intern"), 2000);
          } catch (error) {
            // Error is already handled in resetPassword function
          }
        });

      // Form validation utilities
      function validateEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
      }

      function validatePassword(password) {
        const minLength = password.length >= 8;
        const hasUpper = /[A-Z]/.test(password);
        const hasLower = /[a-z]/.test(password);
        const hasNumber = /\d/.test(password);

        return minLength && hasUpper && hasLower && hasNumber;
      }

      function showFieldError(fieldId, message) {
        const errorElement = document.getElementById(fieldId);
        if (errorElement) {
          errorElement.textContent = message;
          errorElement.classList.remove("hidden");
        }
      }

      function clearFormErrors() {
        const errorElements = document.querySelectorAll(".error-message");
        errorElements.forEach((element) => {
          element.textContent = "";
          element.classList.add("hidden");
        });
      }

      // Utility functions
      function togglePassword(inputId) {
        const input = document.getElementById(inputId);
        const icon = input.nextElementSibling.querySelector("i");

        if (input.type === "password") {
          input.type = "text";
          icon.classList.remove("fa-eye");
          icon.classList.add("fa-eye-slash");
        } else {
          input.type = "password";
          icon.classList.remove("fa-eye-slash");
          icon.classList.add("fa-eye");
        }
      }

      function updateTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString("en-US", {
          hour: "2-digit",
          minute: "2-digit",
          hour12: true,
        });

        const dateString = now.toLocaleDateString("en-US", {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
        });

        const timeElement = document.getElementById("checkInTime");
        const dateElement = document.getElementById("currentDate");

        if (timeElement) timeElement.textContent = timeString;
        if (dateElement) dateElement.textContent = dateString;
      }

      function updateUserUI(name, avatarData) {
        const userName =
          document.getElementById("userName") ||
          document.getElementById("adminName");
        const userAvatar =
          document.getElementById("userAvatar") ||
          document.getElementById("adminAvatar");

        if (userName) userName.textContent = name;

        if (userAvatar) {
          if (typeof avatarData === "string" && avatarData.startsWith("http")) {
            // It's a photo URL
            userAvatar.innerHTML = `<img src="${avatarData}" alt="Profile" class="w-8 h-8 rounded-full object-cover">`;
          } else {
            // It's initials
            userAvatar.textContent = avatarData;
            userAvatar.innerHTML = avatarData; // Reset to text content
          }
        }
      }

      // Attendance functions
      async function manualCheckIn() {
        if (!window.isLocationVerified) {
          showNotification("Location verification required", "error");
          return;
        }

        await window.checkIn();
      }

      async function manualCheckOut() {
        await window.checkOut();
      }

      function updateAttendanceButtons(status) {
        const checkInBtn = document.getElementById("checkInBtn");
        const checkOutBtn = document.getElementById("checkOutBtn");

        if (status === "checked-in") {
          checkInBtn.classList.add("hidden");
          checkOutBtn.classList.remove("hidden");
        } else {
          checkInBtn.classList.remove("hidden");
          checkOutBtn.classList.add("hidden");
        }
      }

      function updateCurrentStatus(status, time) {
        const statusElement = document.getElementById("currentStatus");
        const indicator = statusElement.querySelector(".status-indicator");
        const text = statusElement.querySelector("span:last-child");

        if (status === "checked-in") {
          indicator.className = "status-indicator status-online";
          text.textContent = `Checked in at ${time}`;
        } else if (status === "checked-out") {
          indicator.className = "status-indicator status-offline";
          text.textContent = `Checked out at ${time}`;
        }
      }

      function startWorkingHoursTimer() {
        if (window.workingHoursTimer) {
          clearInterval(window.workingHoursTimer);
        }

        window.workingHoursTimer = setInterval(() => {
          if (window.currentAttendanceSession) {
            const elapsed =
              (Date.now() - window.currentAttendanceSession.checkInTime) /
              (1000 * 60 * 60);
            updateWorkingHours(elapsed);
          }
        }, 60000);
      }

      function stopWorkingHoursTimer() {
        if (window.workingHoursTimer) {
          clearInterval(window.workingHoursTimer);
          window.workingHoursTimer = null;
        }
      }

      function updateWorkingHours(hours) {
        const hoursElement = document.getElementById("workingHours");
        if (hoursElement) {
          const h = Math.floor(hours);
          const m = Math.floor((hours - h) * 60);
          hoursElement.textContent = `${h}:${m.toString().padStart(2, "0")}`;
        }
      }

      function addRecentActivity(action, time) {
        const activityContainer = document.getElementById("recentActivity");
        if (!activityContainer) return;

        // Remove "no activity" message if it exists
        const noActivity = activityContainer.querySelector(".text-center");
        if (noActivity) {
          noActivity.remove();
        }

        const newActivity = document.createElement("div");
        newActivity.className =
          "flex items-center space-x-3 p-3 bg-gray-50 rounded-lg";
        newActivity.innerHTML = `
                <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                <div class="flex-1">
                    <p class="text-sm font-medium text-gray-900">${action}</p>
                    <p class="text-xs text-gray-500">${time}</p>
                </div>
            `;

        activityContainer.insertBefore(
          newActivity,
          activityContainer.firstChild
        );

        // Keep only the last 5 activities
        while (activityContainer.children.length > 5) {
          activityContainer.removeChild(activityContainer.lastChild);
        }
      }

      // QR Code functions
      function startQRScan() {
        const video = document.getElementById("qrVideo");
        const scanner = document.getElementById("qrScanner");

        navigator.mediaDevices
          .getUserMedia({ video: { facingMode: "environment" } })
          .then((stream) => {
            window.qrStream = stream;
            video.srcObject = stream;
            video.classList.remove("hidden");
            scanner.classList.add("hidden");
            video.setAttribute("playsinline", true); // For iOS Safari
            video.play();

            requestAnimationFrame(() => scanQRCode(video));
          })
          .catch((err) => {
            console.error("Camera access denied:", err);
            showNotification("Camera access denied", "error");
          });
      }

      function scanQRCode(video) {
        const canvas = document.getElementById("qrCanvas");
        const context = canvas.getContext("2d");

        function tick() {
          if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.height = video.videoHeight;
            canvas.width = video.videoWidth;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            const imageData = context.getImageData(
              0,
              0,
              canvas.width,
              canvas.height
            );
            const code = jsQR(
              imageData.data,
              imageData.width,
              imageData.height,
              {
                inversionAttempts: "dontInvert", // improves detection speed
              }
            );

            if (code) {
              stopQRScan();
              processQRCode(code.data);
              return;
            }
          }
          requestAnimationFrame(tick);
        }

        tick();
      }

      function stopQRScan() {
        if (window.qrStream) {
          window.qrStream.getTracks().forEach((track) => track.stop());
          window.qrStream = null;
        }

        const video = document.getElementById("qrVideo");
        const scanner = document.getElementById("qrScanner");

        video.classList.add("hidden");
        scanner.classList.remove("hidden");
      }

      function processQRCode(data) {
        try {
          const qrData = JSON.parse(data);

          if (qrData.type === "attendance") {
            if (window.currentAttendanceSession) {
              manualCheckOut(); // use your existing checkout logic
            } else {
              manualCheckIn(); // use your existing checkin logic
            }
          } else {
            showNotification("Invalid QR code", "error");
          }
        } catch (error) {
          console.error("QR processing error:", error);
          showNotification("Invalid QR code format", "error");
        }
      }

      // Form event listeners
      document
        .getElementById("profileForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const profileData = {
            firstName: document.getElementById("profileFirstName").value.trim(),
            lastName: document.getElementById("profileLastName").value.trim(),
            department: document.getElementById("profileDepartment").value,
          };

          if (
            !profileData.firstName ||
            !profileData.lastName ||
            !profileData.department
          ) {
            showNotification("Please fill in all required fields", "error");
            return;
          }

          await window.updateUserProfile(profileData);
        });

      document
        .getElementById("profileCompletionForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const profileData = {
            firstName: document.getElementById("googleFirstName").value.trim(),
            lastName: document.getElementById("googleLastName").value.trim(),
            employeeId: document
              .getElementById("googleEmployeeId")
              .value.trim(),
            department: document.getElementById("googleDepartment").value,
          };

          if (
            !profileData.firstName ||
            !profileData.lastName ||
            !profileData.employeeId ||
            !profileData.department
          ) {
            showNotification("Please fill in all required fields", "error");
            return;
          }

          await window.completeGoogleProfile(profileData);
        });

      document
        .getElementById("addInternForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const userData = {
            firstName: document
              .getElementById("newInternFirstName")
              .value.trim(),
            lastName: document.getElementById("newInternLastName").value.trim(),
            email: document.getElementById("newInternEmail").value.trim(),
            employeeId: document
              .getElementById("newInternEmployeeId")
              .value.trim(),
            department: document.getElementById("newInternDepartment").value,
          };

          const password = document.getElementById("newInternPassword").value;

          if (
            !userData.firstName ||
            !userData.lastName ||
            !userData.email ||
            !userData.employeeId ||
            !userData.department ||
            !password
          ) {
            showNotification("Please fill in all required fields", "error");
            return;
          }

          if (!validateEmail(userData.email)) {
            showNotification("Please enter a valid email address", "error");
            return;
          }

          await window.addNewIntern(userData, password);
        });

      // Admin functions
      function generateDailyQR() {
        const qrData = {
          type: "attendance",
          date: new Date().toDateString(),
          timestamp: Date.now(),
          code: Math.random().toString(36).substr(2, 9),
        };

        const canvas = document.getElementById("qrCodeCanvas");
        if (canvas) {
          QRCode.toCanvas(canvas, JSON.stringify(qrData), {
            width: 200,
            margin: 2,
            color: {
              dark: "#1f2937",
              light: "#ffffff",
            },
          });
        }

        showNotification("Daily QR code generated!", "success");
      }

      function downloadQR() {
        const canvas = document.getElementById("qrCodeCanvas");
        if (canvas) {
          const link = document.createElement("a");
          link.download = `attendance-qr-${new Date().toDateString()}.png`;
          link.href = canvas.toDataURL();
          link.click();
          showNotification("QR code downloaded!", "success");
        }
      }

      function exportAttendance() {
        window.exportAttendanceData();
      }

      function viewReports() {
        showReports();
      }

      // Calendar generation
      function generateCalendar() {
        const calendarDays = document.getElementById("calendarDays");
        const calendarMonth = document.getElementById("calendarMonth");

        if (!calendarDays || !calendarMonth) return;

        const today = new Date();
        const currentMonth = today.getMonth();
        const currentYear = today.getFullYear();
        const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        const daysInMonth = new Date(
          currentYear,
          currentMonth + 1,
          0
        ).getDate();

        const monthNames = [
          "January",
          "February",
          "March",
          "April",
          "May",
          "June",
          "July",
          "August",
          "September",
          "October",
          "November",
          "December",
        ];

        calendarMonth.textContent = `${monthNames[currentMonth]} ${currentYear}`;
        calendarDays.innerHTML = "";

        // Empty cells for days before the first day of the month
        for (let i = 0; i < firstDay; i++) {
          const emptyDay = document.createElement("div");
          emptyDay.className = "h-8";
          calendarDays.appendChild(emptyDay);
        }

        // Days of the month
        for (let day = 1; day <= daysInMonth; day++) {
          const dayElement = document.createElement("div");
          dayElement.className =
            "h-8 flex items-center justify-center text-sm cursor-pointer hover:bg-gray-100 rounded";
          dayElement.textContent = day;

          // Highlight today
          if (day === today.getDate()) {
            dayElement.className += " bg-blue-600 text-white hover:bg-blue-700";
          }

          // Add attendance indicators (will be populated with real data later)
          if (day < today.getDate() && Math.random() > 0.3) {
            dayElement.className += " bg-green-100 text-green-800";
            dayElement.title = "Present";
          }

          calendarDays.appendChild(dayElement);
        }
      }

      // Modal functions
      function showProfile() {
        if (!window.currentUser) return;

        const modal = document.getElementById("profileModal");
        const avatar = document.getElementById("profileAvatar");
        const firstName = document.getElementById("profileFirstName");
        const lastName = document.getElementById("profileLastName");
        const email = document.getElementById("profileEmail");
        const employeeId = document.getElementById("profileEmployeeId");
        const department = document.getElementById("profileDepartment");

        // Populate form with current user data
        avatar.textContent =
          window.currentUser.firstName.charAt(0) +
          window.currentUser.lastName.charAt(0);
        firstName.value = window.currentUser.firstName || "";
        lastName.value = window.currentUser.lastName || "";
        email.value = window.currentUser.email || "";
        employeeId.value = window.currentUser.employeeId || "";
        department.value = window.currentUser.department || "";

        modal.classList.remove("hidden");

        closeAllMenus();
      }

      function closeProfile() {
        document.getElementById("profileModal").classList.add("hidden");
      }

      function showSettings() {
        document.getElementById("settingsModal").classList.remove("hidden");
        closeAllMenus();
      }

      function closeSettings() {
        document.getElementById("settingsModal").classList.add("hidden");
      }

      function showAddIntern() {
        document.getElementById("addInternModal").classList.remove("hidden");
      }

      function closeAddIntern() {
        document.getElementById("addInternModal").classList.add("hidden");
        document.getElementById("addInternForm").reset();
      }

      function showReports() {
        loadReportsData();
        document.getElementById("reportsModal").classList.remove("hidden");
      }

      function closeReports() {
        document.getElementById("reportsModal").classList.add("hidden");
      }

      function showProfileCompletion(userData) {
        const modal = document.getElementById("profileCompletionModal");
        const photo = document.getElementById("googleUserPhoto");
        const initials = document.getElementById("googleUserInitials");
        const firstName = document.getElementById("googleFirstName");
        const lastName = document.getElementById("googleLastName");
        const email = document.getElementById("googleEmail");
        const employeeId = document.getElementById("googleEmployeeId");

        // Show user photo or initials
        if (userData.photoURL) {
          photo.src = userData.photoURL;
          photo.classList.remove("hidden");
          initials.classList.add("hidden");
        } else {
          initials.textContent =
            userData.firstName.charAt(0) + (userData.lastName.charAt(0) || "");
          photo.classList.add("hidden");
          initials.classList.remove("hidden");
        }

        // Populate form
        firstName.value = userData.firstName || "";
        lastName.value = userData.lastName || "";
        email.value = userData.email || "";
        employeeId.value = userData.employeeId || "";

        modal.classList.remove("hidden");
        hideAllPages();
      }

      function closeProfileCompletion() {
        document
          .getElementById("profileCompletionModal")
          .classList.add("hidden");
      }

      function closeAllMenus() {
        const menus = ["userMenu", "adminUserMenu"];
        menus.forEach((menuId) => {
          const menu = document.getElementById(menuId);
          if (menu) menu.classList.add("hidden");
        });
      }

      // Settings functions
      function saveSettings() {
        const emailNotifications =
          document.getElementById("emailNotifications").checked;
        const locationTracking =
          document.getElementById("locationTracking").checked;
        const darkMode = document.getElementById("darkMode").checked;

        // Save to localStorage for now (could be saved to Firebase)
        localStorage.setItem(
          "settings",
          JSON.stringify({
            emailNotifications,
            locationTracking,
            darkMode,
          })
        );

        if (darkMode) {
          document.body.classList.add("dark");
        } else {
          document.body.classList.remove("dark");
        }

        showNotification("Settings saved successfully!", "success");
        closeSettings();
      }

      function changePassword() {
        showNotification("Password change feature - Coming soon!", "info");
      }

      // Reports functions
      async function loadReportsData() {
        if (!window.currentUser) return;

        try {
          const now = new Date();
          const startOfWeek = new Date(
            now.setDate(now.getDate() - now.getDay())
          );
          const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

          let attendanceQuery;
          if (window.userRole === "admin") {
            attendanceQuery = query(
              collection(window.firebaseDb, "attendance"),
              where("createdAt", ">=", startOfMonth)
            );
          } else {
            attendanceQuery = query(
              collection(window.firebaseDb, "attendance"),
              where("userId", "==", window.currentUser.uid),
              where("createdAt", ">=", startOfMonth)
            );
          }

          const attendanceDocs = await getDocs(attendanceQuery);
          const attendanceData = attendanceDocs.docs.map((doc) => doc.data());

          // Calculate weekly attendance
          const weeklyData = attendanceData.filter(
            (record) =>
              record.createdAt && record.createdAt.toDate() >= startOfWeek
          );
          const weeklyRate =
            weeklyData.length > 0
              ? (weeklyData.filter((r) => r.status === "checked-out").length /
                  weeklyData.length) *
                100
              : 0;

          // Calculate monthly attendance
          const monthlyRate =
            attendanceData.length > 0
              ? (attendanceData.filter((r) => r.status === "checked-out")
                  .length /
                  attendanceData.length) *
                100
              : 0;

          // Calculate total hours
          const totalHours = attendanceData.reduce(
            (sum, record) => sum + (record.workingHours || 0),
            0
          );

          // Update UI
          document.getElementById(
            "weeklyAttendance"
          ).textContent = `${weeklyRate.toFixed(1)}%`;
          document.getElementById(
            "monthlyAttendanceRate"
          ).textContent = `${monthlyRate.toFixed(1)}%`;
          document.getElementById(
            "totalHours"
          ).textContent = `${totalHours.toFixed(1)}h`;

          // Load recent activity
          const reportsActivity = document.getElementById("reportsActivity");
          reportsActivity.innerHTML = "";

          attendanceData.slice(0, 10).forEach((record) => {
            const activity = document.createElement("div");
            activity.className =
              "flex items-center justify-between p-2 bg-white rounded border";
            activity.innerHTML = `
                        <div>
                            <p class="text-sm font-medium">${
                              record.userName || "Unknown User"
                            }</p>
                            <p class="text-xs text-gray-500">${
                              record.date || "Unknown Date"
                            }</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm">${
                              record.workingHours
                                ? record.workingHours.toFixed(1) + "h"
                                : "N/A"
                            }</p>
                            <p class="text-xs text-gray-500">${
                              record.status || "Unknown"
                            }</p>
                        </div>
                    `;
            reportsActivity.appendChild(activity);
          });
        } catch (error) {
          console.error("Error loading reports data:", error);
          showNotification("Error loading reports data", "error");
        }
      }

      function exportReports() {
        window.exportAttendanceData();
      }

      // Email log functions
      function viewEmailLog() {
        const emailLog = JSON.parse(localStorage.getItem("emailLog") || "[]");
        const emailLogContent = document.getElementById("emailLogContent");
        const emailLogCount = document.getElementById("emailLogCount");

        emailLogCount.textContent = emailLog.length;

        if (emailLog.length === 0) {
          emailLogContent.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-envelope text-2xl mb-2"></i>
                        <p>No emails sent yet</p>
                    </div>
                `;
        } else {
          emailLogContent.innerHTML = "";

          emailLog.reverse().forEach((email, index) => {
            const emailEntry = document.createElement("div");
            emailEntry.className = "bg-white p-4 rounded-lg border";

            const typeColors = {
              info: "bg-blue-100 text-blue-800",
              reminder: "bg-yellow-100 text-yellow-800",
              success: "bg-green-100 text-green-800",
              error: "bg-red-100 text-red-800",
            };

            emailEntry.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-1">
                                    <span class="px-2 py-1 text-xs font-medium rounded-full ${
                                      typeColors[email.type] || typeColors.info
                                    }">
                                        ${email.type.toUpperCase()}
                                    </span>
                                    <span class="text-sm text-gray-600">
                                        ${new Date(
                                          email.timestamp
                                        ).toLocaleString()}
                                    </span>
                                </div>
                                <h4 class="font-medium text-gray-900">${
                                  email.subject
                                }</h4>
                                <p class="text-sm text-gray-600">To: ${
                                  email.to
                                }</p>
                            </div>
                            <button onclick="toggleEmailBody(${index})" class="text-blue-600 hover:text-blue-800 text-sm">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </div>
                        <div id="emailBody${index}" class="hidden mt-3 p-3 bg-gray-50 rounded text-sm text-gray-700 whitespace-pre-wrap">
                            ${email.body}
                        </div>
                    `;

            emailLogContent.appendChild(emailEntry);
          });
        }

        document.getElementById("emailLogModal").classList.remove("hidden");
      }

      function toggleEmailBody(index) {
        const emailBody = document.getElementById(`emailBody${index}`);
        emailBody.classList.toggle("hidden");
      }

      function closeEmailLog() {
        document.getElementById("emailLogModal").classList.add("hidden");
      }

      function clearEmailLog() {
        if (
          confirm(
            "Are you sure you want to clear the email log? This action cannot be undone."
          )
        ) {
          localStorage.removeItem("emailLog");
          showNotification("Email log cleared successfully", "success");
          viewEmailLog(); // Refresh the view
        }
      }

      function exportEmailLog() {
        const emailLog = JSON.parse(localStorage.getItem("emailLog") || "[]");

        if (emailLog.length === 0) {
          showNotification("No email log data to export", "warning");
          return;
        }

        // Prepare CSV data
        const csvData = [];
        csvData.push(["Timestamp", "To", "Subject", "Type", "Status", "Body"]);

        emailLog.forEach((email) => {
          csvData.push([
            new Date(email.timestamp).toLocaleString(),
            email.to,
            email.subject,
            email.type,
            email.status,
            email.body.replace(/\n/g, " "), // Replace newlines with spaces for CSV
          ]);
        });

        // Create and download CSV
        const csvContent = csvData
          .map((row) =>
            row
              .map((field) => `"${field.toString().replace(/"/g, '""')}"`)
              .join(",")
          )
          .join("\n");

        const blob = new Blob([csvContent], { type: "text/csv" });
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = `email-log-${
          new Date().toISOString().split("T")[0]
        }.csv`;
        link.click();
        window.URL.revokeObjectURL(url);

        showNotification("Email log exported successfully!", "success");
      }

      // UI functions
      function toggleUserMenu(type = "intern") {
        const menuId = type === "admin" ? "adminUserMenu" : "userMenu";
        const menu = document.getElementById(menuId);
        if (menu) {
          menu.classList.toggle("hidden");
        }
      }

      async function logout() {
        try {
          showLoading();
          await window.firebaseAuth.signOut();

          // Clean up
          window.currentUser = null;
          window.userRole = null;
          window.currentAttendanceSession = null;
          stopWorkingHoursTimer();

          // Clear any listeners
          window.attendanceListeners.forEach((unsubscribe) => unsubscribe());
          window.attendanceListeners = [];

          showNotification("Logged out successfully", "info");
        } catch (error) {
          console.error("Logout error:", error);
          showNotification("Error logging out", "error");
        } finally {
          hideLoading();
        }
      }

      // Loading and notification functions
      function showLoading() {
        document.getElementById("loadingOverlay").classList.remove("hidden");
      }

      function hideLoading() {
        document.getElementById("loadingOverlay").classList.add("hidden");
      }

      function showNotification(message, type = "info", duration = 5000) {
        const container = document.getElementById("notificationContainer");
        const notification = document.createElement("div");

        const colors = {
          success: "bg-green-500",
          error: "bg-red-500",
          warning: "bg-yellow-500",
          info: "bg-blue-500",
        };

        const icons = {
          success: "fa-check-circle",
          error: "fa-times-circle",
          warning: "fa-exclamation-triangle",
          info: "fa-info-circle",
        };

        notification.className = `notification ${colors[type]} text-white px-6 py-4 rounded-lg shadow-lg flex items-center space-x-3 max-w-sm`;
        notification.innerHTML = `
                <i class="fas ${icons[type]}"></i>
                <span class="flex-1">${message}</span>
                <button onclick="this.parentElement.remove()" class="text-white hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            `;

        container.appendChild(notification);

        // Animate in
        setTimeout(() => notification.classList.add("show"), 100);

        // Auto remove
        setTimeout(() => {
          notification.classList.remove("show");
          setTimeout(() => notification.remove(), 300);
        }, duration);
      }

      // Network status monitoring
      function updateNetworkStatus() {
        const offlineIndicator = document.getElementById("offlineIndicator");

        if (navigator.onLine) {
          offlineIndicator.classList.remove("show");
        } else {
          offlineIndicator.classList.add("show");
        }
      }

      // Search and filter functionality for intern management
      document
        .getElementById("searchInterns")
        ?.addEventListener("input", filterInternsManagement);
      document
        .getElementById("filterDepartment")
        ?.addEventListener("change", filterInternsManagement);

      function filterInternsManagement() {
        const searchTerm =
          document.getElementById("searchInterns").value.toLowerCase() || "";
        const departmentFilter =
          document.getElementById("filterDepartment").value || "";

        const rows = document.querySelectorAll("#internsList tr");

        rows.forEach((row) => {
          if (row.cells.length < 7) return; // Skip empty rows

          const name =
            row.cells[0]
              ?.querySelector(".text-gray-900")
              ?.textContent.toLowerCase() || "";
          const email =
            row.cells[0]
              ?.querySelector(".text-gray-500")
              ?.textContent.toLowerCase() || "";
          const department = row.cells[1]?.textContent.toLowerCase() || "";

          const matchesSearch =
            name.includes(searchTerm) || email.includes(searchTerm);
          const matchesDepartment =
            !departmentFilter ||
            department.includes(departmentFilter.toLowerCase());

          if (matchesSearch && matchesDepartment) {
            row.style.display = "";
          } else {
            row.style.display = "none";
          }
        });
      }

      // Click outside to close modals
      document.addEventListener("click", function (e) {
        // Close user menus when clicking outside
        if (!e.target.closest(".relative")) {
          closeAllMenus();
        }

        // Close modals when clicking outside
        const modals = [
          "profileModal",
          "settingsModal",
          "addInternModal",
          "reportsModal",
          "profileCompletionModal",
          "emailLogModal",
        ];
        modals.forEach((modalId) => {
          const modal = document.getElementById(modalId);
          if (modal && !modal.classList.contains("hidden")) {
            const modalContent = modal.querySelector(".bg-white");
            if (!modalContent.contains(e.target)) {
              // Don't allow closing profile completion modal by clicking outside
              if (modalId !== "profileCompletionModal") {
                modal.classList.add("hidden");
              }
            }
          }
        });
      });

      // Session persistence check
      function checkSessionPersistence() {
        const savedUser = localStorage.getItem("currentUser");
        const savedRole = localStorage.getItem("userRole");
        const lastLoginTime = localStorage.getItem("lastLoginTime");

        if (savedUser && savedRole && lastLoginTime) {
          try {
            const userData = JSON.parse(savedUser);
            const loginTime = parseInt(lastLoginTime);
            const now = Date.now();
            const sessionDuration = now - loginTime;
            const maxSessionDuration = 24 * 60 * 60 * 1000; // 24 hours

            if (sessionDuration < maxSessionDuration) {
              // Session is still valid, restore user data
              window.currentUser = userData;
              window.userRole = savedRole;

              console.log("Session restored from localStorage");

              // Firebase auth will handle the rest when it initializes
              return true;
            } else {
              // Session expired, clear data
              localStorage.removeItem("currentUser");
              localStorage.removeItem("userRole");
              localStorage.removeItem("lastLoginTime");
              console.log("Session expired, cleared localStorage");
            }
          } catch (error) {
            console.error("Error parsing saved session:", error);
            localStorage.removeItem("currentUser");
            localStorage.removeItem("userRole");
            localStorage.removeItem("lastLoginTime");
          }
        }

        return false;
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", function () {
        updateTime();
        updateNetworkStatus();

        // Check for existing session
        const hasValidSession = checkSessionPersistence();
        if (hasValidSession) {
          showNotification("Restoring your session...", "info");
        }

        // Network status listeners
        window.addEventListener("online", updateNetworkStatus);
        window.addEventListener("offline", updateNetworkStatus);

        // Load saved settings
        const savedSettings = localStorage.getItem("settings");
        if (savedSettings) {
          try {
            const settings = JSON.parse(savedSettings);
            const emailNotifications =
              document.getElementById("emailNotifications");
            const locationTracking =
              document.getElementById("locationTracking");
            const darkMode = document.getElementById("darkMode");

            if (emailNotifications)
              emailNotifications.checked = settings.emailNotifications || false;
            if (locationTracking)
              locationTracking.checked = settings.locationTracking !== false; // Default to true
            if (darkMode) darkMode.checked = settings.darkMode || false;

            if (settings.darkMode) {
              document.body.classList.add("dark");
            }
          } catch (error) {
            console.error("Error loading saved settings:", error);
          }
        }

        // Auto-save form data to prevent data loss
        setupAutoSave();

        if (!hasValidSession) {
          showNotification(
            "Welcome to AttendanceHub! Professional attendance management with Google Authentication support.",
            "info"
          );
        }
      });

      // Auto-save form data
      function setupAutoSave() {
        const forms = [
          "loginForm",
          "signupForm",
          "profileForm",
          "addInternForm",
        ];

        forms.forEach((formId) => {
          const form = document.getElementById(formId);
          if (form) {
            const inputs = form.querySelectorAll("input, select");
            inputs.forEach((input) => {
              if (input.type !== "password") {
                // Don't save passwords
                input.addEventListener("input", function () {
                  const key = `autosave_${formId}_${input.id}`;
                  localStorage.setItem(key, input.value);
                });

                // Restore saved value
                const key = `autosave_${formId}_${input.id}`;
                const savedValue = localStorage.getItem(key);
                if (savedValue && !input.value) {
                  input.value = savedValue;
                }
              }
            });
          }
        });
      }

      // Clear auto-saved form data
      function clearAutoSave(formId) {
        const form = document.getElementById(formId);
        if (form) {
          const inputs = form.querySelectorAll("input, select");
          inputs.forEach((input) => {
            const key = `autosave_${formId}_${input.id}`;
            localStorage.removeItem(key);
          });
        }
      }
    </script>
    <script>
      (function () {
        function c() {
          var b = a.contentDocument || a.contentWindow.document;
          if (b) {
            var d = b.createElement("script");
            d.innerHTML =
              "window.__CF$cv$params={r:'974c617ed55e259d',t:'MTc1NjEzODQ0OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";
            b.getElementsByTagName("head")[0].appendChild(d);
          }
        }
        if (document.body) {
          var a = document.createElement("iframe");
          a.height = 1;
          a.width = 1;
          a.style.position = "absolute";
          a.style.top = 0;
          a.style.left = 0;
          a.style.border = "none";
          a.style.visibility = "hidden";
          document.body.appendChild(a);
          if ("loading" !== document.readyState) c();
          else if (window.addEventListener)
            document.addEventListener("DOMContentLoaded", c);
          else {
            var e = document.onreadystatechange || function () {};
            document.onreadystatechange = function (b) {
              e(b);
              "loading" !== document.readyState &&
                ((document.onreadystatechange = e), c());
            };
          }
        }
      })();
    </script>
  </body>
</html>
